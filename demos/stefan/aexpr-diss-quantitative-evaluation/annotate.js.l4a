{"type":"Reference","version":"d2e7cce4e36d00c2eb5756bf7efa13d65e08f1a0","content":"import diff from 'src/external/diff-match-patch.js';\nconst dmp = new diff.diff_match_patch();\n\nconst folderURL = 'https://lively-kernel.org/lively4/aexpr/demos/stefan/aexpr-diss-quantitative-evaluation/'\nconst allURL = folderURL + 'signals-plain.all.js'\nconst all = await allURL.fetchText()\nconst detectionURL = folderURL + 'signals-plain.detection.js'\nconst detection = await detectionURL.fetchText()\n\nlet textDiff = dmp.diff_main(all, detection);\n\ntextDiff\n\nconst annotations = []\nfunction newAnnotation(from, to, color) {\n  const anno = `{\"from\":${from},\"to\":${to},\"name\":\"color\",\"color\":\"${color}\"}`\n  annotations.push(anno)\n}\n\nconst COLOR_REACTION = \"#a1d99b\"\nconst COLOR_DETECTION = \"#fdd49e\"\n\nlet pos = 0;\nfor (let change of textDiff) {\n  debugger\n  const { 0: type, 1: content } = change\n  const isAdd = type === 1;\n  if (isAdd) {\n    break;\n    // throw new Error(`Unexpected addition of '${content}'`)\n  }\n\n  const isDel = type === -1;\n  const isSame = type === 0;\n  \n  const length = content.length;\n  \n  const newPos = pos + length;\n  const delOrAdd = isDel ? -1 : 1;\n  \n  if (isSame) {\n    newAnnotation(pos, newPos, COLOR_DETECTION)\n    pos = newPos\n    continue;\n  }\n  \n  if (isDel) {\n    newAnnotation(pos, newPos, COLOR_REACTION)\n    pos = newPos\n    continue;\n  }\n  \n  throw new Error(`Unexpected type of change: ${type}`)\n  \n  if (isAdd || isDel) {\n    for (const annotation of this.list) {\n\n      // simplest implementation... just grow and shrink with the diff\n      if (pos <= annotation.from) {\n        annotation.from += delOrAdd * length;\n      }\n      if (pos <= annotation.to) {\n        annotation.to += delOrAdd * length;\n      }\n    }\n  }\n}\nawait lively.files.saveFile(allURL + '.l4a', annotations.join('\\n'))\n\n\n"}
{"from":643,"to":652,"name":"color","color":"#9ecae1"}
{"from":671,"to":676,"name":"color","color":"#a1d99b"}
{"from":683,"to":686,"name":"color","color":"#a1d99b"}
{"from":704,"to":707,"name":"color","color":"#fdd49e"}
{"from":732,"to":734,"name":"color","color":"repeating-linear-gradient(-45deg, rgba(253, 212, 158, 0.4), rgba(253, 212, 158, 0.4) 10px, rgba(161, 217, 155, 0.4) 10px, rgba(161, 217, 155, 0.4) 20px)"}
{"from":737,"to":740,"name":"color","color":"repeating-linear-gradient(-45deg, rgba(253, 212, 158, 0.4), rgba(253, 212, 158, 0.4) 10px, rgba(161, 217, 155, 0.4) 10px, rgba(161, 217, 155, 0.4) 20px)"}
{"from":674,"to":684,"name":"color","color":"#a1d99b"}
{"from":638,"to":643,"name":"color","color":"#fdd49e"}
{"from":655,"to":664,"name":"color","color":"#a1d99b"}