/*! lively.lang-v0.3.5 2015-02-13 */

!function(Global){function createLivelyLangObject(){return{chain:chain,noConflict:noConflict,installGlobals:installGlobals,uninstallGlobals:uninstallGlobals,globalInterfaceSpec:globalInterfaceSpec,deprecatedLivelyPatches:deprecatedLivelyPatches}}function chain(a){if(!a)return a;if(Array.isArray(a))return createChain(livelyLang.arr,a);if("Date"===a.constructor.name)return createChain(livelyLang.date,a);switch(typeof a){case"string":return createChain(livelyLang.string,a);case"object":return createChain(livelyLang.obj,a);case"function":return createChain(livelyLang.fun,a);case"number":return createChain(livelyLang.num,a)}throw new Error("Chain for object "+a+" ("+a.constructor.name+") no supported")}function createChain(a,b){return Object.keys(a).reduce(function(c,d){return c[d]=function(){var c=Array.prototype.slice.call(arguments),e=a[d].apply(null,[b].concat(c));return chain(e)},c},{value:function(){return b}})}function noConflict(){if(!isNode){var a=livelyLang._prevLivelyGlobal;a?delete Global.lively.lang:delete Global.lively}return livelyLang}function installGlobals(){globalInterfaceSpec.forEach(function(a){if("installMethods"===a.action){var b=livelyLang.Path(a.target);b.isIn(Global)||b.set(Global,{},!0);var c=livelyLang.Path(a.sources[0]);a.methods.forEach(function(a){installProperty(c.concat([a]),b.concat([a]))}),a.alias&&a.alias.forEach(function(a){installProperty(c.concat([a[1]]),b.concat([a[0]]))})}else{if("installObject"!==a.action)throw new Error("Cannot deal with global setup action: "+a.action);var b=livelyLang.Path(a.target),d=livelyLang.Path(a.source).get(livelyLang);b.set(Global,d,!0)}})}function installProperty(a,b){if(!a.isIn(livelyLang)){var c=new Error("property not provided by lively.lang: "+a);throw console.error(c.stack||c),c}var d=a.get(livelyLang);if("function"==typeof d&&"prototype"===b.slice(-2,-1).toString()){var e=d;d=function(){var a=Array.prototype.slice.call(arguments);return a.unshift(this),e.apply(null,a)},d.toString=function(){return e.toString()}}b.set(Global,d,!0)}function uninstallGlobals(){globalInterfaceSpec.forEach(function(a){if("installMethods"===a.action){var b=livelyLang.Path(a.target),c=b.get(Global);if(!c)return;a.methods.forEach(function(a){delete c[a]}),a.alias&&a.alias.forEach(function(a){delete c[a[0]]})}else{if("installObject"!==a.action)throw new Error("Cannot deal with global setup action: "+a.action);var b=livelyLang.Path(a.target);b.del(Global)}})}function deprecatedLivelyPatches(){livelyLang.installGlobals(),Global.$A=Array.from,Function.evalJS=livelyLang.fun.evalJS=function(src){return eval(src)},livelyLang.Path.type=livelyLang.PropertyPath,livelyLang.Path.prototype.serializeExpr=function(){return"lively.PropertyPath("+livelyLang.obj.inspect(this.parts())+")"},livelyLang.Closure.type="lively.Closure",livelyLang.fun.methodChain=livelyLang.fun.wrapperChain,"undefined"!=typeof JSON&&(JSON.prettyPrint=function(a){return JSON.stringify(a,null,2)}),Global.NativeArrayFunctions=livelyLang.arrNative}var globalInterfaceSpec=[{action:"installMethods",target:"Array",sources:["arr"],methods:["from","genN","range","withN"]},{action:"installMethods",target:"Array.prototype",sources:["arr"],methods:["all","any","batchify","clear","clone","collect","compact","delimWith","detect","doAndContinue","each","equals","filterByKey","findAll","first","flatten","forEachShowingProgress","grep","groupBy","groupByKey","histogram","include","inject","intersect","invoke","last","mapAsync","mapAsyncSeries","mask","max","min","mutableCompact","nestedDelay","partition","pluck","pushAll","pushAllAt","pushAt","pushIfNotIncluded","reMatches","reject","rejectByKey","remove","removeAt","replaceAt","rotate","shuffle","size","sortBy","sortByKey","sum","swap","toArray","toTuples","union","uniq","uniqBy","without","withoutAll","zip"],alias:[["select","filter"],["find","detect"]]},{action:"installMethods",target:"Date",sources:["date"],methods:[]},{action:"installMethods",target:"Date.prototype",sources:["date"],methods:["equals","format","relativeTo"]},{action:"installMethods",target:"Function",sources:["fun"],methods:["fromString"]},{action:"installMethods",target:"Function.prototype",sources:["fun"],methods:["addToObject","argumentNames","asScript","asScriptOf","binds","curry","delay","functionNames","localFunctionNames","getOriginal","getVarMapping","logCalls","logCompletion","logErrors","qualifiedMethodName","setProperty","traceCalls","wrap"]},{action:"installMethods",target:"Number",sources:["num"],methods:[]},{action:"installMethods",target:"Number.prototype",sources:["num"],methods:["detent","randomSmallerInteger","roundTo","toDegrees","toRadians"]},{action:"installMethods",target:"Object",sources:["obj"],methods:["addScript","clone","deepCopy","extend","inherit","isArray","isBoolean","isElement","isEmpty","isFunction","isNumber","isObject","isRegExp","isString","isUndefined","merge","mergePropertyInHierarchy","values","valuesInPropertyHierarchy"]},{action:"installMethods",target:"Object.prototype",sources:["obj"],methods:[]},{action:"installMethods",target:"String.prototype",sources:["string"],methods:["camelize","capitalize","digitValue","empty","endsWith","hashCode","include","pad","regExpEscape","startsWith","startsWithVowel","succ","times","toArray","toQueryParams","truncate"]},{action:"installMethods",target:"Function.prototype",sources:["class"],methods:["create","addMethods","isSubclassOf","superclasses","categoryNameFor","remove"],alias:[["subclass","create"]]},{action:"installObject",target:"Numbers",source:"num",methods:["average","between","convertLength","humanReadableByteSize","median","normalRandom","parseLength","random","sort"]},{action:"installObject",target:"Properties",source:"properties",methods:["all","allOwnPropertiesOrFunctions","allProperties","any","forEachOwn","hash","nameFor","own","ownValues","values"]},{action:"installObject",target:"Strings",source:"string",methods:["camelCaseString","createDataURI","diff","format","formatFromArray","indent","lineIndexComputer","lines","md5","newUUID","nonEmptyLines","pad","paragraphs","peekLeft","peekRight","print","printNested","printTable","printTree","quote","reMatches","removeSurroundingWhitespaces","stringMatch","tableize","tokens","unescapeCharacterEntities","withDecimalPrecision"]},{action:"installObject",target:"Objects",source:"obj",methods:["asObject","equals","inspect","isMutableType","safeToString","shortPrintStringOf","typeStringOf"]},{action:"installObject",target:"Functions",source:"fun",methods:["all","compose","composeAsync","createQueue","debounce","debounceNamed","either","extractBody","flip","notYetImplemented","once","own","throttle","throttleNamed","timeToRun","timeToRunN","waitFor","workerWithCallbackQueue","wrapperChain"]},{action:"installObject",target:"Grid",source:"grid"},{action:"installObject",target:"Interval",source:"interval"},{action:"installObject",target:"lively.ArrayProjection",source:"arrayProjection"},{action:"installObject",target:"lively.Closure",source:"Closure"},{action:"installObject",target:"lively.Grouping",source:"Group"},{action:"installObject",target:"lively.PropertyPath",source:"Path"},{action:"installObject",target:"lively.Worker",source:"worker"},{action:"installObject",target:"lively.Class",source:"classHelper"}],isNode="undefined"!=typeof process&&process.versions&&process.versions.node,livelyLang=createLivelyLangObject();if(isNode)module.exports=livelyLang;else if(livelyLang._prevLivelyGlobal=Global.lively,Global.lively||(Global.lively={}),Global.lively.lang)for(var name in livelyLang)Global.lively.lang[name]=livelyLang[name];else Global.lively.lang=livelyLang}("undefined"!=typeof window?window:global),function(a){"use strict";{var b="undefined"!=typeof process&&process.versions&&process.versions.node;a.events={makeEmitter:b?function(a){if(a.on&&a.removeListener)return a;var b=require("events");return require("util")._extend(a,b.EventEmitter.prototype),b.EventEmitter.call(a),a}:function(a){return a.on&&a.removeListener?a:(a.listeners={},a.on=function(b,c){c&&(a.listeners[b]||(a.listeners[b]=[]),a.listeners[b].push(c))},a.once=function(b,c){function d(){a.removeListener(b,d),c.apply(this,arguments)}c&&a.on(b,d)},a.removeListener=function(b,c){a.listeners[b]&&(a.listeners[b]=a.listeners[b].filter(function(a){return a!==c}))},a.removeAllListeners=function(b){a.listeners[b]&&(a.listeners[b]=[])},a.emit=function(){var b=Array.prototype.slice.call(arguments),c=b.shift(),d=a.listeners[c];d&&d.length&&d.forEach(function(a){try{a.apply(null,b)}catch(c){console.error("Error in event handler: %s",c.stack||String(c))}})},a)}}}}("undefined"!=typeof lively&&lively.lang?lively.lang:require("./base")),function(a){"use strict";function b(a){if(a&&e.isArray(a))return"["+a.map(b)+"]";if("string"!=typeof a)return String(a);var c=String(a);return c=c.replace(/\n/g,"\\n\\\n"),c=c.replace(/(")/g,"\\$1"),c='"'+c+'"'}function c(a){if(a.superclass)return[];var b=a.toString().match(/^[\s\(]*function[^(]*\(([^)]*)\)/)[1].replace(/\/\/.*?[\r\n]|\/\*(?:.|[\r\n])*?\*\//g,"").replace(/\s+/g,"").split(",");return 1!=b.length||b[0]?b:[]}function d(a,b,c){if(!c||0>=c)return a;for(;c>0;)c--,a=b+a;return a}var e=a.obj={isArray:function(a){return a&&Array.isArray(a)},isElement:function(a){return a&&1==a.nodeType},isFunction:function(a){return a instanceof Function},isBoolean:function(a){return"boolean"==typeof a},isString:function(a){return"string"==typeof a},isNumber:function(a){return"number"==typeof a},isUndefined:function(a){return"undefined"==typeof a},isRegExp:function(a){return a instanceof RegExp},isObject:function(a){return"object"==typeof a},isEmpty:function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},equals:function(a,b){function c(a,b){for(var c in a)if("function"!=typeof a[c]&&!e.equals(a[c],b[c]))return!1;return!0}if(!a&&!b)return!0;if(!a||!b)return!1;switch(a.constructor){case String:case Date:case Boolean:case Number:return a==b}return"function"==typeof a.isEqualNode?a.isEqualNode(b):"function"==typeof a.equals?a.equals(b):c(a,b)&&c(b,a)},keys:Object.keys||function(a){var b=[];for(var c in a)b.push(c);return b},values:function(a){return a?Object.keys(a).map(function(b){return a[b]}):[]},addScript:function(b,c,d,e){var f=a.fun.fromString(c);return a.fun.asScriptOf(f,b,d,e)},extend:function(a,b){for(var c=null,d=1;d<arguments.length;d++)if("string"!=typeof arguments[d]){var b=arguments[d];for(var e in b){var f=b.__lookupGetter__(e),g=b.__lookupSetter__(e);if(f&&a.__defineGetter__(e,f),g&&a.__defineSetter__(e,g),!f&&!g){var h=b[e];a[e]=h,c&&c.push(e),"function"==typeof h&&(h.name&&0!=h.name.length||h.displayName||(h.displayName=e),"undefined"!=typeof lively&&lively.Module&&lively.Module.current&&(h.sourceModule=lively.Module.current()))}}}else{var i=arguments[d];a.categories||(a.categories={}),a.categories[i]||(a.categories[i]=[]),c=a.categories[i]}return a},clone:function(b){return Array.isArray(b)?Array.prototype.slice.call(b):a.obj.extend({},b)},extract:function(a,b,c){return a.reduce(function(a,d){if(b.hasOwnProperty(d)){var e=c?c(d,b[d]):b[d];a[d]=e}return a},{})},inspect:function g(a,e,f){if(e=e||{},f=f||0,!a)return b(a);if("function"==typeof a)return e.printFunctionSource?String(a):"function"+(a.name?" "+a.name:"")+"("+c(a).join(",")+") {/*...*/}";switch(a.constructor){case String:case Boolean:case RegExp:case Number:return b(a)}if("function"==typeof a.serializeExpr)return a.serializeExpr();var h=a&&Array.isArray(a),i=h?"[":"{",j=h?"]":"}";if(e.maxDepth&&f>=e.maxDepth)return i+"/*...*/"+j;var k=[];if(k=h?a.map(function(a){return g(a,e,f)}):Object.keys(a).sort(function(b,c){var d="function"==typeof a[b],e="function"==typeof a[c];return d===e?c>b?-1:b>c?1:0:d?1:-1}).map(function(b){h&&g(a[b],e,f+1);var c=g(a[b],e,f+1);return e.escapeKeys?Strings.print(b):b+": "+c}),0===k.length)return i+j;var l=k.join(","),m=!h&&(!e.minLengthForNewLine||l.length>=e.minLengthForNewLine),n=d("",e.indent||"  ",f),o=d("",e.indent||"  ",f+1),p=m?"\n"+o:"",q=m?"\n"+n:"";return m&&(l=k.join(","+p)),i+p+l+q+j},merge:function(a){return arguments.length>1?e.merge(Array.prototype.slice.call(arguments)):Array.isArray(a[0])?Array.prototype.concat.apply([],a):a.reduce(function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},{})},inherit:function(a){return Object.create(a)},valuesInPropertyHierarchy:function(a,b){for(var c=[],d=a;d;)d.hasOwnProperty(b)&&c.unshift(d[b]),d=Object.getPrototypeOf(d);return c},mergePropertyInHierarchy:function(a,b){return this.merge(this.valuesInPropertyHierarchy(a,b))},deepCopy:function(a){if(!a||"object"!=typeof a)return a;var b=Array.isArray(a)?Array(a.length):{};for(var c in a)a.hasOwnProperty(c)&&(b[c]=e.deepCopy(a[c]));return b},typeStringOf:function(a){return null===a?"null":"undefined"==typeof a?"undefined":a.constructor.name},shortPrintStringOf:function(a){function b(a,b,d,e){a.constructor.name===b&&(c+=d,(a.length||Object.keys(a).length)&&(c+="..."),c+=e)}if(!this.isMutableType(a))return this.safeToString(a);if("Object"!==a.constructor.name&&!Array.isArray(a)&&a.constructor.name)return a.constructor.name?a.constructor.name:Object.prototype.toString.call(a).split(" ")[1].split("]")[0];var c="";return b(a,"Object","{","}"),b(a,"Array","[","]"),c},isMutableType:function(a){var b=["null","undefined","Boolean","Number","String"];return-1===b.indexOf(this.typeStringOf(a))},safeToString:function(a){try{return(a?a.toString():String(a)).replace("\n","")}catch(b){return"<error printing object>"}},asObject:function(a){switch(typeof a){case"string":return new String(a);case"boolean":return new Boolean(a);case"number":return new Number(a);default:return a}}},f=(a.properties={all:function(a,b){var c=[];for(var d in a)!a.__lookupGetter__(d)&&"function"==typeof a[d]||(b?!b(d,a):0)||c.push(d);return c},allOwnPropertiesOrFunctions:function(a,b){return Object.getOwnPropertyNames(a).reduce(function(c,d){return(b?b(a,d):!0)&&c.push(d),c},[])},own:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&(a.__lookupGetter__(c)||"function"!==a[c])&&b.push(c);return b},forEachOwn:function(a,b,c){var d=[];for(var e in a)if(a.hasOwnProperty(e)){var f=a[e];"function"!==f&&d.push(b.call(c||this,e,f))}return d},nameFor:function(a,b){for(var c in a)if(a[c]===b)return c;return void 0},values:function(a){var b=[];for(var c in a)b.push(a[c]);return b},ownValues:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b},any:function(a,b){for(var c in a)if(b(a,c))return!0;return!1},allProperties:function(a,b){var c=[];for(var d in a)(b?b(a,d):!0)&&c.push(d);return c},hash:function(a){return Object.keys(a).sort().join("").hashCode()}},a.Path=function h(a,b){return a instanceof h?a:this instanceof h?(b&&this.setSplitter(b),this.fromPath(a)):new h(a,b)});e.extend(f,{superclass:Object,type:"Path",categories:{}}),e.extend(f.prototype,{isPathAccessor:!0,splitter:".",fromPath:function(a){return e.isString(a)&&""!==a&&a!==this.splitter?(this._parts=a.split(this.splitter),this._path=a):e.isArray(a)?(this._parts=[].concat(a),this._path=a.join(this.splitter)):(this._parts=[],this._path=""),this},setSplitter:function(a){return a&&(this.splitter=a),this},parts:function(){return this._parts},size:function(){return this._parts.length},slice:function(a,b){return f(this.parts().slice(a,b))},normalizePath:function(){return this._path},isRoot:function(){return 0===this._parts.length},isIn:function(a){if(this.isRoot())return!0;var b=this.get(a,-1);return b&&b.hasOwnProperty(this._parts[this._parts.length-1])},equals:function(a){return a&&a.isPathAccessor&&this.parts().equals(a.parts())},isParentPathOf:function(a){a=a&&a.isPathAccessor?a:f(a);for(var b=this.parts(),c=a.parts(),d=0;d<b.length;d++)if(b[d]!=c[d])return!1;return!0},relativePathTo:function(a){return a=f(a),this.isParentPathOf(a)?a.slice(this.size(),a.size()):void 0},del:function(a){if(this.isRoot())return!1;for(var b=a,c=0;c<this._parts.length-1;c++){var d=this._parts[c];if(!b.hasOwnProperty(d))return!1;b=b[d]}return delete b[this._parts[this._parts.length-1]]},set:function(a,b,c){if(this.isRoot())return void 0;for(var d=a,e=0;e<this._parts.length-1;e++){var f=this._parts[e];if(!d.hasOwnProperty(f)||"object"!=typeof d[f]&&"function"!=typeof d[f]){if(!c)return void 0;d=d[f]={}}else d=d[f]}return d[this._parts[this._parts.length-1]]=b},get:function(a,b){var c=b?this._parts.slice(0,b):this._parts;return c.reduce(function(a,b){return a?a[b]:a},a)},concat:function(a,b){return f(this.parts().concat(f(a,b).parts()))},toString:function(){return this.normalizePath()},serializeExpr:function(){return"Path("+Objects.inspect(this.parts())+")"},watch:function(b){if(b&&!this.isRoot()){var c=b.target,d=this.get(c,-1),e=a.arr.last(this.parts()),f="propertyWatcher$"+e,g=d&&d.hasOwnProperty(f),h=b.uninstall,i=(b.haltWhenChanged,b.showStack),j=d.__lookupGetter__(e),k=d.__lookupSetter__(e);if(c&&e&&d){if(h){if(!g)return;delete d[e],d[e]=d[f],delete d[f];var l="Watcher for "+d+"."+e+" uninstalled";return void show(l)}if(g){var l="Watcher for "+d+"."+e+" already installed";return void show(l)}if(j||k){var l=d+'["'+e+'"] is a getter/setter, watching not support';return console.log(l),void("undefined"==typeof show&&show(l))}d[f]=d[e],d.__defineSetter__(e,function(a){var c=d[f];b.onSet&&b.onSet(a,c);var g=d+"."+e+" changed: "+c+" -> "+a;return i&&(g+="\n"+("undefined"!=typeof lively?lively.printStack():console.trace())),b.verbose&&(console.log(g),"undefined"!=typeof show&&show(g)),d[f]=a}),d.__defineGetter__(e,function(){return b.onGet&&b.onGet(d[f]),d[f]});var l="Watcher for "+d+"."+e+" installed";console.log(l),"undefined"!=typeof show&&show(l)}}},debugFunctionWrapper:function(a){var b=a.target,c=this.get(b,-1),d=this.parts().last(),e=a.uninstall,f=(void 0===a.haltWhenChanged?!0:a.haltWhenChanged,a.showStack),g=c&&d&&c[d],h=g&&g.isDebugFunctionWrapper;if(b&&d&&g&&c){if(e){if(!h)return;c[d]=c[d].debugTargetFunction;var i="Uninstalled debugFunctionWrapper for "+c+"."+d;return console.log(i),"undefined"!=typeof show&&show(i),void show(i)}if(h){var i="debugFunctionWrapper for "+c+"."+d+" already installed";return console.log(i),void("undefined"!=typeof show&&show(i))}var j=c[d]=g.wrap(function(){var b=Array.from(arguments);return f&&show(lively.printStack()),a.verbose&&show(d+" called"),b.shift().apply(c,b)});j.isDebugFunctionWrapper=!0,j.debugTargetFunction=g;var i="debugFunctionWrapper for "+c+"."+d+" installed";console.log(i),"undefined"!=typeof show&&show(i)}}})}("undefined"!=typeof lively&&lively.lang?lively.lang:require("./base")),function(a){"use strict";var b=(a.arrNative={sort:function(a){a||(a=function(a,b){return b>a?-1:a>b?1:0});for(var b=(this.length,[]),c=0;c<this.length;c++){for(var d=!1,e=0;e<b.length;e++)if(1===a(b[e],this[c])){d=!0,b[e+1]=b[e],b[e]=this[c];break}d||b.push(this[c])}return b},filter:function(a,b){for(var c=[],d=0;d<this.length;d++)if(this.hasOwnProperty(d)){var e=this[d];a.call(b,e,d)&&c.push(e)}return c},forEach:function(a,b){for(var c=0,d=this.length;d>c;c++)a.call(b,this[c],c,this)},some:function(a,b){return void 0!==this.detect(a,b)},every:function(a,b){for(var c=!0,d=0,e=this.length;e>d&&(c=c&&!!a.call(b,this[d],d),c);d++);return c},map:function(a,b){var c=[];return this.forEach(function(d,e){c.push(a.call(b,d,e))}),c},reduce:function(a,b,c){var d=0;arguments.hasOwnProperty(1)||(d=1,b=this[0]);for(var e=d;e<this.length;e++)b=a.call(c,b,this[e],e,this);return b},reduceRight:function(a,b,c){var d=this.length-1;arguments.hasOwnProperty(1)||(d--,b=this[this.length-1]);for(var e=d;e>=0;e--)b=a.call(c,b,this[e],e,this);return b}},a.arr={range:function(a,b,c){c=c||1;for(var d=[],e=a;b>=e;e+=c)d.push(e);return d},from:function(a){if(!a)return[];if(Array.isArray(a))return a;if(a.toArray)return a.toArray();for(var b=a.length,c=new Array(b);b--;)c[b]=a[b];return c},withN:function(a,b){for(var c=new Array(a);a>0;)c[--a]=b;return c},genN:function(a,b){for(var c=new Array(a);a>0;)c[--a]=b(a);return c},filter:function(a,b,c){return a.filter(b,c)},detect:function(a,b,c){for(var d,e=0,f=a.length;f>e;e++)if(d=a[e],b.call(c,d,e))return d;return void 0},filterByKey:function(a,b){return a.filter(function(a){return!!a[b]})},grep:function(a,b){return"string"==typeof b&&(b=new RegExp(b,"i")),a.filter(b.test.bind(b))},mask:function(a,b){return a.filter(function(a,c){return!!b[c]})},reject:function(a,b,c){function d(a,d){return!b.call(c,a,d)}return a.filter(d)},rejectByKey:function(a,b){return a.filter(function(a){return!a[b]})},without:function(a,b){return a.filter(function(a){return a!==b})},withoutAll:function(a,b){return a.filter(function(a){return-1===b.indexOf(a)})},uniq:function(a,b){return a.inject([],function(a,c,d){return 0!==d&&(b?a.last()==c:a.include(c))||a.push(c),a})},uniqBy:function(a,c,d){for(var e=b.clone(a),f=0;f<e.length;f++)for(var g=a[f],h=f+1;h<e.length;h++)c.call(d,g,e[h])&&(b.removeAt(e,h),h--);return e},compact:function(a){return a.filter(function(a){return!!a})},mutableCompact:function(a){for(var b=0,c=0,d=a.length;d>b;)a.hasOwnProperty(b)&&(a[c++]=a[b]),b++;for(;c++<d;)a.pop();return a},forEach:function(a,b,c){return a.forEach(b,c)},zip:function(){var a=b.from(arguments),c=a.shift(),d="function"==typeof b.last(a)?a.pop():function(a){return a},e=[c].concat(a).map(b.from);return c.map(function(a,c){return d(b.pluck(e,c),c)})},flatten:function g(a){return a.reduce(function(a,b){return a.concat(Array.isArray(b)?g(b):[b])},[])},flatmap:function(a,b,c){return Array.prototype.concat.apply([],a.map(b,c))},interpose:function(a,b){return a.reduce(function(a,c){return a.length>0&&a.push(b),a.push(c),a},[])},delimWith:function(a,c){return b.interpose(a,c)},map:function(a,b,c){return a.map(b,c)},invoke:function(a,b,c,d,e,f,g,h){return a.map(function(a){return a[b](c,d,e,f,g,h)})},pluck:function(a,b){return a.map(function(a){return a[b]})},reduce:function(a,b,c,d){return a.reduce(b,c,d)},reduceRight:function(a,b,c,d){return a.reduceRight(b,c,d)},isArray:Array.isArray,include:function(a,b){return-1!==a.indexOf(b)},some:function(a,b,c){return a.some(b,c)},every:function(a,b,c){return a.every(b,c)},equals:function(a,b){var c=a.length;if(!b||c!==b.length)return!1;for(var d=0;c>d;d++){if(a[d]&&b[d]&&a[d].equals&&b[d].equals){if(a[d].equals(b[d]))continue;return!1}if(a[d]!=b[d])return!1}return!0},sort:function(a,b){return a.sort(b)},sortBy:function(a,c,d){return b.pluck(a.map(function(a,b){return{value:a,criteria:c.call(d,a,b)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;return d>c?-1:c>d?1:0}),"value")},sortByKey:function(a,c){return b.sortBy(a,function(a){return a[c]})},reverse:function(a){return a.reverse()},reversed:function(a){return b.clone(a).reverse()},reMatches:function(a,b,c){return c=c||String,a.map(function(a){return c(a).match(b)})},first:function(a){return a[0]},last:function(a){return a[a.length-1]},intersect:function(a,c){return b.uniq(a).filter(function(a){return c.indexOf(a)>-1})},union:function(a,c){for(var d=b.clone(a),e=0;e<c.length;e++){var f=c[e];-1===d.indexOf(f)&&d.push(f)}return d},pushAt:function(a,b,c){a.splice(c,0,b)},removeAt:function(a,b){a.splice(b,1)},remove:function(a,c){var d=a.indexOf(c);return d>=0&&b.removeAt(a,d),c},pushAll:function(a,b){for(var c=0;c<b.length;c++)a.push(b[c]);return a},pushAllAt:function(a,b,c){a.splice.apply(a,[c,0].concat(b))},pushIfNotIncluded:function(a,c){b.include(a,c)||a.push(c)},replaceAt:function(a,b,c){a.splice(c,1,b)},clear:function(a){return a.length=0,a},doAndContinue:function(a,b,c,d){return c=c||Functions.Null,d=d||("undefined"!=typeof window?window:global),b=b||function(a,b,c){b.call(d,a,c)},a.reduceRight(function(a,c,e){return function(){b.call(d,a,c,e)}},c)()},nestedDelay:function(a,b,c,d,e,f){return d=d||function(){},a.clone().reverse().inject(d,function(a,d,g){return function(){b.call(e||("undefined"!=typeof window?window:global),d,g),f&&g%f!==0?a():a.delay(c)}})()},forEachShowingProgress:function(){var a,b,c,d,e,f=Array.from(arguments),g=f.shift(),h=g.length,i=!1;if(1===f.length?(a=f[0].progressBar,b=f[0].iterator,c=f[0].labelFunction,d=f[0].whenDone,e=f[0].context):(a=f[0],b=f[1],c=f[2],d=f[3],e=f[4]),e||(e="undefined"!=typeof window?window:global),c||(c=function(a){return a}),!a){i=!0;var j="undefined"!=typeof window?window:global,k=j.lively&&lively.morphic&&lively.morphic.World.current();a=k?k.addProgressBar():{setValue:function(){},setLabel:function(){},remove:function(){}}}return a.setValue(0),g.reduceRight(function(d,f,g){return function(){try{a.setValue(g/h),c&&a.setLabel(c.call(e,f,g)),b.call(e,f,g)}catch(i){console.error("Error in forEachShowingProgress at %s (%s)\n%s\n%s",g,f,i,i.stack)}d.delay(0)}},function(){a.setValue(1),i&&function(){a.remove()}.delay(0),d&&d.call(e)})(),g},swap:function(a,b,c){0>b&&(b=a.length+b),0>c&&(c=a.length+c);var d=a[b];return a[b]=a[c],a[c]=d,a},rotate:function(a,b){return b=b||1,a.slice(b).concat(a.slice(0,b))},groupBy:function(a,b,d){return c.fromArray(a,b,d)},groupByKey:function(a,c){return b.groupBy(a,function(a){return a[c]})},partition:function(a,b,c){b=b||function(a){return a};var d=[],e=[];return a.forEach(function(a,f){(b.call(c,a,f)?d:e).push(a)}),[d,e]},batchify:function(a,b,c){function d(a,e){if(!e.length)return[a,[]];var f=e[0],g=e.slice(1),h=a.concat([f]);if(b.call(c,h))return d(h,g);var i=d(a,g);return[i[0],[f].concat(i[1])]}function e(a,b){if(!b.length)return a;var c=d([],b);if(!c[0].length)throw new Error("Batchify constrained does not ensure consumption of at least one item per batch!");return e(a.concat([c[0]]),c[1])}return e([],a)},toTuples:function(a,c){return c=c||1,b.range(0,Math.ceil(a.length/c)-1).map(function(b){return a.slice(b*c,b*c+c)},a)},shuffle:function(a){var c=b.range(0,a.length-1);return a.reduce(function(a,b){var d=c.splice(Math.round(Math.random()*(c.length-1)),1);return a[d]=b,a},Array(a.length))},max:function(a,b,c){b=b||function(a){return a};var d;return a.reduce(function(a,e,f){var g=b.call(c,e,f);return"number"!=typeof g||a>=g?a:(d=e,g)},-1/0),d},min:function(a,c,d){return c=c||function(a){return a},b.max(a,function(a,b){return-c.call(d,a,b)})},sum:function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c];return b},count:function(a,b){return a.reduce(function(a,c){return c===b?a+1:a},0)},size:function(a){return a.length},histogram:function(a,c){if("undefined"==typeof c||"number"==typeof c){var d=c||function(){return Math.ceil(Math.log(a.length)/Math.log(2)+1)}(a),e=Math.ceil(Math.round(a.length/d));return b.range(0,d-1).map(function(b){return a.slice(b*e,(b+1)*e)})}if(c instanceof Array){var f=c;return a.reduce(function(a,b){if(b<f[1])return a[0].push(b),a;for(var c=1;c<f.length;c++)if(b>=f[c]&&(!f[c+1]||b<=f[c+1]))return a[c].push(b),a;throw new Error(Strings.format("Histogram creation: Cannot group data %s into thresholds %o",b,f))},b.range(1,f.length).map(function(){return[]}))}},clone:function(a){return[].concat(a)},toArray:function(a){return b.from(a)},each:function(a,b,c){return a.forEach(b,c)},all:function(a,b,c){return a.every(b,c)},any:function(a,b,c){return a.some(b,c)},collect:function(a,b,c){return a.map(b,c)},findAll:function(a,b,c){return a.filter(b,c)},inject:function(a,b,c,d){return d&&(c=c.bind(d)),a.reduce(c,b)},mapAsyncSeries:function(b,c,d){function e(a,b){if(!g&&(a||b)){g=!0;try{d(a,f)}catch(c){console.error("Error in mapAsyncSeries - callback invocation error:\n"+(c.stack||c))}}}var f=[],g=!1;return b.reduceRight(function(b,d,h){return g?void 0:function(g,i){if(g)return e(g);h>0&&f.push(i);try{c(d,h,a.fun.once(b))}catch(j){e(j)}}},function(a,b){f.push(b),e(a,!0)})()},mapAsync:function(b,c,d,e){function f(){for(;l<c.parallel&&k<b.length;)m[k++]()}function g(a,c){if(!(i.indexOf(a)>-1||(i.push(a),l--,j))){if(!c&&i.length<b.length)return void f();j=!0;try{e&&e(c,h)}catch(d){console.error("Error in mapAsync - main callback invocation error:\n"+(d.stack||d))}}}"function"==typeof c&&(e=d,d=c,c=null),c=c||{},c.parallel||(c.parallel=b.length-1);var h=[],i=[],j=!1,k=0,l=0,m=b.map(function(b,c){return function(){l++;try{d(b,c,a.fun.once(function(a,b){h[c]=a||b,g(c,a)}))}catch(e){g(c,e)}}});return f()}}),c=a.Group=function(){};c.by=a.arr.groupBy,c.fromArray=function(a,b,d){for(var e=new c,f=0,g=a.length;g>f;f++){var h=b.call(d,a[f],f);e[h]||(e[h]=[]),e[h].push(a[f])}return e},c.prototype.toArray=function(){return this.reduceGroups(function(a,b,c){return a.concat([c])},[])},c.prototype.forEach=function(a,b){var c=this;return Object.keys(c).forEach(function(d){c[d].forEach(a.bind(b,d))}),c},c.prototype.forEachGroup=function(a,b){var c=this;return Object.keys(c).forEach(function(d){a.call(b,d,c[d])}),c},c.prototype.map=function(a,b){var d=new c;return this.forEachGroup(function(c,e){d[c]=e.map(a.bind(b,c))}),d},c.prototype.mapGroups=function(a,b){var d=new c;return this.forEachGroup(function(c,e){d[c]=a.call(b,c,e)}),d},c.prototype.keys=function(){return Object.keys(this)},c.prototype.reduceGroups=function(a,b,c){return this.forEachGroup(function(d,e){b=a.call(c,b,d,e)}),b},c.prototype.count=function(){return this.reduceGroups(function(a,b,c){return a[b]=c.length,a},{})};var d=a.grid={create:function(a,c,d){for(var e=new Array(a);a>0;)e[--a]=b.withN(c,d);return e},mapCreate:function(a,b,c,d){for(var e=new Array(a),f=0;a>f;f++){e[f]=new Array(b);for(var g=0;b>g;g++)e[f][g]=c.call(d||this,f,g)}return e},forEach:function(a,b,c){a.forEach(function(a,d){a.forEach(function(a,e){b.call(c||this,a,d,e)})})},map:function(a,b,c){var d=new Array(a.length);return a.forEach(function(a,e){d[e]=new Array(a.length),a.forEach(function(a,f){d[e][f]=b.call(c||this,a,e,f)})}),d},toObjects:function(a){for(var b=a[0],c=new Array(a.length-1),d=1;d<a.length;d++)for(var e=c[d-1]={},f=0;f<b.length;f++)e[b[f]]=a[d][f];return c},tableFromObjects:function(a,b){Array.isArray(a)||(a=[a]);var c=[[]],d=c[0],e=a.reduce(function(a,b){return a.concat([Object.keys(b).reduce(function(a,c){var e=d.indexOf(c);return-1===e&&(e=d.length,d.push(c)),a[e]=b[c],a},[])])},[]);return b=1===arguments.length?null:b,e.forEach(function(a){for(var c=0;c<d.length;c++)a[c]||(a[c]=b)}),c.concat(e)},benchmark:function(){var b,c=[],e=d.create(1e3,200,1),f=0;b=lively.lang.fun.timeToRunN(function(){d.forEach(e,function(a){f+=a})},10),c.push(a.string.format("grid.forEach: %ims",b));var g;b=Functions.timeToRunN(function(){g=d.map(d,function(a,b,c){return b+c+Math.round(100*Math.random())})},10),c.push(a.string.format("grid.map: %ims",b));var h=d.create(1e3,2e3);return b=Functions.timeToRunN(function(){h=new Array(1e3);for(var a=0;1e3>a;a++)h[a]=new Array(2e3);d.forEach(e,function(a,b,c){h[b][c]=b+c+Math.round(100*Math.random())})},10),c.push("grid.map with forEach: "+b+"ms"),c.push("--= 2012-09-22 =--\ngrid.forEach: 14.9ms\ngrid.map: 19.8ms\ngrid.map with forEach: 38.7ms\n"),c.join("\n")}},e=a.interval={isInterval:function(a){return Array.isArray(a)&&a.length>=2&&a[0]<=a[1]},sort:function(a){return a.sort(e.compare)},compare:function(a,b){return a[0]<b[0]?a[1]<b[0]?-3:a[1]===b[0]?-2:-1:a[0]===b[0]?a[1]===b[1]?0:a[1]<b[1]?-1:1:-1*e.compare(b,a)},coalesce:function(a,b,c){var d=this.compare(a,b);switch(d){case-3:case 3:return null;case 0:return c&&c(a,b,a),a;case 2:case 1:var e=a;a=b,b=e;case-2:case-1:var f=[a[0],Math.max(a[1],b[1])];return c&&c(a,b,f),f;default:throw new Error("Interval compare failed")}},coalesceOverlapping:function(a,b){for(var c=[],d=a.length;d>0;){var f=a.shift();d--;for(var g=0;d>g;g++){var h=a[g],i=e.coalesce(f,h,b);i&&(f=i,a.splice(g,1),d--,g--)}c.push(f)}return this.sort(c)},mergeOverlapping:function(a,b,c){for(var d=[];a.length>0;){var f=a.shift(),g=b.map(function(a){var b=e.compare(f,a);return-1===b||0===b||1===b});d.push(c(f,g[0])),d.push(f)}return d},intervalsInRangeDo:function(a,b,c,d,e,f){f=f||("undefined"!=typeof window?window:global),c=this.sort(c);for(var g,h=[];g=c.shift();)if(!(g[1]<a)){g[0]<a&&(g=Array.prototype.slice.call(g),g[0]=a);var i=b<g[0]?b:g[0];if(i>a&&h.push(d.call(f,[a,i],!0)),b<g[1]&&(g=Array.prototype.slice.call(g),g[1]=b),g[0]===g[1]){var j;e&&(j=h.slice(-1)[0])&&e.call(f,j,g,j)
}else h.push(d.call(f,g,!1));if(a=g[1],a>=b)break}return b>a&&h.push(d.call(f,[a,b],!0)),h},intervalsInbetween:function(a,b,c){return e.intervalsInRangeDo(a,b,e.coalesceOverlapping(Array.prototype.slice.call(c)),function(a,b){return b?a:null}).filter(function(a){return!!a})},mapToMatchingIndexes:function(a,c){var d,e,f=0;return c.map(function(c){for(;(e=a[f])&&e[0]<c[0];)f++;if(e&&e[0]===c[0]){for(d=f;(e=a[d])&&e[1]<c[1];)d++;if(e&&e[1]===c[1])return b.range(f,d)}return[]})},benchmark:function(){function a(a,b,c){return Strings.format("%s: %sms",a,Functions.timeToRunN(function(){e[a].apply(e,b,1e5)},c))}return["Friday, 20. July 2012:","coalesceOverlapping: 0.0003ms","intervalsInbetween: 0.002ms","mapToMatchingIndexes: 0.02ms","vs.\n"+new Date+":",a("coalesceOverlapping",[[[9,10],[1,8],[3,7],[15,20],[14,21]]],1e5),a("intervalsInbetween",[0,10,[[8,10],[0,2],[3,5]]],1e5),a("mapToMatchingIndexes",[Array.range(0,1e3).collect(function(a){return[a,a+1]}),[[4,8],[500,504],[900,1004]]],1e3)].join("\n")}},f=a.arrayProjection={create:function(a,b,c){var d=c||0;return d+b>a.length&&(d-=d+b-a.length),{array:a,from:d,to:d+b}},toArray:function(a){return a.array.slice(a.from,a.to)},originalToProjectedIndex:function(a,b){return b<a.from||b>=a.to?null:b-a.from},projectedToOriginalIndex:function(a,b){return 0>b||b>a.to-a.from?null:a.from+b},transformToIncludeIndex:function(a,b){if(!(b in a.array))return null;var c=0;return b<a.from&&(c=-a.from+b),b>=a.to&&(c=b-a.to+1),0===c?a:f.create(a.array,a.to-a.from,a.from+c)}}}("undefined"!=typeof lively&&lively.lang?lively.lang:require("./base")),function(a){"use strict";var b=a.tree={prewalk:function(a,c,d){c(a),(d(a)||[]).forEach(function(a){b.prewalk(a,c,d)})},postwalk:function(a,c,d){(d(a)||[]).forEach(function(a){b.postwalk(a,c,d)}),c(a)},detect:function(c,d,e){if(d(c))return c;var f;return a.arr.detect(e(c)||[],function(a){return f=b.detect(a,d,e)}),f},filter:function(c,d,e){var f=[];return d(c)&&f.push(c),f.concat(a.arr.flatten((e(c)||[]).map(function(a){return b.filter(a,d,e)})))},map:function(c,d,e){var f=[d(c)];return f.concat(a.arr.flatten((e(c)||[]).map(function(a){return b.map(a,d,e)})))},mapTree:function(a,c,d){var e=(d(a)||[]).map(function(a){return b.mapTree(a,c,d)});return c(a,e)}}}("undefined"!=typeof lively&&lively.lang?lively.lang:require("./base")),function(exports){"use strict";function Closure(){this.initialize.apply(this,arguments)}var fun=exports.fun={get Empty(){return function(){}},get K(){return function(a){return a}},get Null(){return function(){return null}},get False(){return function(){return!1}},get True(){return function(){return!0}},get notYetImplemented(){return function(){throw new Error("Not yet implemented")}},all:function(a){var b=[];for(var c in a)a.__lookupGetter__(c)||"function"!=typeof a[c]||b.push(c);return b},own:function(a){var b=[];for(var c in a)!a.__lookupGetter__(c)&&a.hasOwnProperty(c)&&"function"==typeof a[c]&&b.push(c);return b},argumentNames:function(a){if(a.superclass)return[];var b=a.toString().match(/^[\s\(]*function[^(]*\(([^)]*)\)/);if(!b||!b[1])return[];var c=b[1].replace(/\/\/.*?[\r\n]|\/\*(?:.|[\r\n])*?\*\//g,"").replace(/\s+/g,"").split(",");return 1!=c.length||c[0]?c:[]},qualifiedMethodName:function(a){var b="";return a.declaredClass?b+=a.declaredClass+">>":a.declaredObject&&(b+=a.declaredObject+"."),b+(a.methodName||a.displayName||a.name||"anonymous")},extractBody:function(a){var b=String(a).replace(/^function[^\{]+\{\s*/,"").replace(/\}$/,"").trim(),c=b.split(/\n|\r/).map(function(a){var b=a.match(/^\s*/);return b&&b[0]}).filter(function(a){return!!a}).reduce(function(a,b){return b.length<a.length?b:a});return b.replace(new RegExp("^"+c,"gm"),"")},timeToRun:function(a){var b=Date.now();return a(),Date.now()-b},timeToRunN:function(a,b){for(var c=Date.now(),d=0;b>d;d++)a();return(Date.now()-c)/b},delay:function(a,b){var c=Array.prototype.slice.call(arguments),d=c.shift(),b=1e3*c.shift();return setTimeout(function(){return d.apply(d,c)},b)},throttle:function(a,b){var c,d,e,f,g,h,i=fun.debounce(b,function(){g=f=!1});return function(){c=this,d=arguments;var j=function(){e=null,g&&a.apply(c,d),i()};return e||(e=setTimeout(j,b)),f?g=!0:h=a.apply(c,d),i(),f=!0,h}},debounce:function(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,c||b.apply(e,f)};c&&!d&&b.apply(e,f),clearTimeout(d),d=setTimeout(g,a)}},throttleNamed:function(a,b,c){function d(){fun.debounceNamed(a,b,function(){delete e[a]})(),c.apply(this,arguments)}var e=fun._throttledByName||(fun._throttledByName={});return e[a]?e[a]:e[a]=fun.throttle(d,b)},debounceNamed:function(a,b,c,d){function e(){delete f[a],c.apply(this,arguments)}var f=fun._debouncedByName||(fun._debouncedByName={});return f[a]?f[a]:f[a]=fun.debounce(b,e,d)},createQueue:function(a,b){var c=fun._queues||(fun._queues={}),d=c[a]||(c[a]={_workerActive:!1,worker:b,tasks:[],drain:null,push:function(a){d.tasks.push(a),d.activateWorker()},pushAll:function(a){a.forEach(function(a){d.tasks.push(a)}),d.activateWorker()},pushNoActivate:function(a){d.tasks.push(a)},handleError:function(a){a&&console.error("Error in queue: "+a)},activateWorker:function(){function b(a){d.handleError(a),d.activateWorker()}var e=d.tasks,f=d._workerActive;if(0===e.length)f&&(d._workerActive=!1,"function"==typeof d.drain&&d.drain()),delete c[a];else{f||(d._workerActive=!0);try{d.worker(e.shift(),b)}catch(g){b(g)}}}});return d},workerWithCallbackQueue:function(a,b,c){function d(){k&&clearTimeout(k),i=!0,delete f[a]}function e(b){i||(d(),g.callbacks.forEach(function(c){try{c.apply(null,b)}catch(d){console.error("Error when invoking callbacks in queueUntil ["+a+"]:\n"+String(d.stack||d))}}))}var f=fun._queueUntilCallbacks||(fun._queueUntilCallbacks={}),g=f[a],h=!!g;if(h)return g;var i=!1,j=!1;if(c)var k=setTimeout(function(){i||e([new Error("timeout")])},c);return g=f[a]={callbacks:[],cancel:function(){j=!0,d()},whenDone:function(a){return g.callbacks.push(a),g}},setTimeout(function(){if(!j)try{b(function(){e(arguments)})}catch(a){e([a])}},0),g},composeAsync:function(){var a,b=Array.prototype.slice,c=b.call(arguments);return c.reverse().reduce(function(c,d){var e=!1;return function(){function f(){e=!0;var d=b.call(arguments),f=d.shift();f?a&&a(f):c.apply(null,d)}var g=b.call(arguments);if(!a){for(;g.length&&"function"!=typeof g[g.length-1];)g.pop();a="function"==typeof g[g.length-1]?g.pop():function(){}}try{d.apply(this,g.concat([f]))}catch(h){console.error("composeAsync: ",h.stack||h),!e&&a&&a(h)}}},function(){a.apply(null,[null].concat(b.call(arguments)))})},compose:function(){var a=Array.prototype.slice.call(arguments);return a.reverse().reduce(function(a,b){return function(){return a(b.apply(this,arguments))}},function(a){return a})},flip:function(a){return function(){var b=Array.prototype.slice.call(arguments),c=[b[1],b[0]].concat(b.slice(2));return a.apply(null,c)}},waitFor:function(a,b,c){var d=Date.now(),e=50;c||(c=b,b=a,a=void 0),function f(){if(b())return c();if(a){var g=Date.now()-d,h=a-g;if(0>=h)return c(new Error("timeout"));e>h&&(e=h)}setTimeout(f,e)}()},waitForAll:function(a,b,c){function d(a,b,d,g){if(f.length){var h=null,i=f.indexOf(a);i>-1&&f.splice(i,1),d?(f.length=0,h=new Error("in waitForAll at"+("number"==typeof b?" "+b:"")+": \n"+(d.stack||String(d)))):g&&(e[b]=g),f.length||setTimeout(function(){c(h,e)},0)}}c||(c=b,b=a,a=null),a=a||{};var e=b.map(function(){return null});if(!b.length)return void c(null,e);var f=Array.prototype.slice.call(b);b.forEach(function(a,b){try{a(function(){var c=Array.prototype.slice.call(arguments),e=c.shift();d(a,b,e,c)})}catch(c){d(a,b,c,null)}}),a.timeout&&setTimeout(function(){if(f.length){var a=e.map(function(a,b){return null===a&&b}).filter(function(a){return"number"==typeof a}).join(", "),b=new Error("waitForAll timed out, functions at "+a+" not done");d(null,null,b,null)}},a.timeout)},curry:function(a){function b(){return a.apply(this,c.concat(Array.prototype.slice.call(arguments)))}if(arguments.length<=1)return arguments[0];var c=Array.prototype.slice.call(arguments),a=c.shift();return b.isWrapper=!0,b.originalFunction=a,b},wrap:function(a,b){var c=a,d=function(){var a=Array.prototype.slice.call(arguments),d=b.isWrapper?a:[c.bind(this)].concat(a);return b.apply(this,d)};return d.isWrapper=!0,d.originalFunction=c,d},getOriginal:function(a){for(;a.originalFunction;)a=a.originalFunction;return a},wrapperChain:function(a){var b=[];do b.push(a),a=a.originalFunction;while(a);return b},replaceMethodForOneCall:function(a,b,c){c.originalFunction=a[b];var d=a.hasOwnProperty(b);return a[b]=function(){return d?a[b]=c.originalFunction:delete a[b],c.apply(this,arguments)},a},once:function(a){if(!a)return void 0;if("function"!=typeof a)throw new Error("fun.once() expecting a function");var b,c=!1;return function(){return c?b:(c=!0,b=a.apply(this,arguments))}},either:function(){var a=Array.prototype.slice.call(arguments),b=!1;return a.map(function(a){return function(){return b?void 0:(b=!0,a.apply(this,arguments))}})},eitherNamed:function(a,b){var c=Array.prototype.slice.call(arguments),d=fun._eitherNameRegistry||(fun._eitherNameRegistry={}),a=c.shift(),e=d[a]||(d[a]={wasCalled:!1,callsLeft:0});return e.callsLeft++,function(){return e.callsLeft--,e.callsLeft<=0&&delete d[a],e.wasCalled?void 0:(e.wasCalled=!0,b.apply(this,arguments))}},evalJS:function(src){return eval(src)},fromString:function(a){return fun.evalJS("("+a.toString()+");")},asScript:function(a,b){return Closure.fromFunction(a,b).recreateFunc()},asScriptOf:function(a,b,c,d){var e=c||a.name;if(!e)throw Error("Function that wants to be a script needs a name: "+this);var f=Object.getPrototypeOf(b),g={"this":b};if(d&&(g=exports.obj.merge([g,d])),f&&f[e]){var h=function(){try{return Object.getPrototypeOf(b)[e].apply(b,arguments)}catch(a){return void 0!==typeof $world?$world.logError(a,"Error in $super call"):alert("Error in $super call: "+a+"\n"+a.stack),null}};g.$super=Closure.fromFunction(h,{obj:b,name:e}).recreateFunc()}return fun.addToObject(fun.asScript(a,g),b,e)},addToObject:function(a,b,c){a.displayName=c;var d=b.attributeConnections?b.attributeConnections.filter(function(a){return"update"===a.getSourceAttrName()}):[];return d&&d.forEach(function(a){a.disconnect()}),b[c]=a,a.declaredObject=exports.obj.safeToString(b),"undefined"!=typeof lively&&exports.obj&&lively.Tracing&&lively.Tracing.stackTracingEnabled&&lively.Tracing.instrumentMethod(b,c,{declaredObject:exports.obj.safeToString(b)}),d&&d.forEach(function(a){a.connect()}),a},binds:function(a,b){return Closure.fromFunction(a,b||{}).recreateFunc()},setLocalVarValue:function(a,b,c){a.hasLivelyClosure&&(a.livelyClosure.funcProperties[b]=c)},getVarMapping:function(a){return a.hasLivelyClosure?a.livelyClosure.varMapping:a.isWrapper?a.originalFunction.varMapping:a.varMapping?a.varMapping:{}},setProperty:function(a,b,c){a[b]=c,a.hasLivelyClosure&&(a.livelyClosure.funcProperties[b]=c)},functionNames:function(a){for(var b=[],c=a.prototype;c;)b=Object.keys(c).reduce(function(a,b){return"function"==typeof c[b]&&-1===a.indexOf(b)&&a.push(b),a},b),c=Object.getPrototypeOf(c);return b},localFunctionNames:function(a){return Object.keys(a.prototype).filter(function(b){return"function"==typeof a.prototype[b]})},logErrors:function(a,b){var c=function(c){var d=Array.prototype.slice.call(arguments);d.shift();try{return c.apply(a,d)}catch(e){if("undefined"!=typeof lively&&lively.morphic&&lively.morphic.World&&lively.morphic.World.current())throw lively.morphic.World.current().logError(e),e;throw b?console.warn("ERROR: %s.%s(%s): err: %s %s",a,b,d,e,e.stack||""):console.warn("ERROR: %s %s",e,e.stack||""),"undefined"!=typeof logStack&&logStack(),"undefined"!=typeof printObject&&console.warn("details: "+printObject(e)),e}};c.methodName="$logErrorsAdvice";var d=fun.wrap(a,c);return d.originalFunction=a,d.methodName="$logErrorsWrapper",d},logCompletion:function(a,b){var c=function(c){var d=Array.prototype.slice.call(arguments);d.shift();try{var e=c.apply(a,d)}catch(f){throw console.warn("failed to load "+b+": "+f),"undefined"!=typeof lively&&lively.lang.Execution&&lively.lang.Execution.showStack(),f}return console.log("completed "+b),e};c.methodName="$logCompletionAdvice::"+b;var d=fun.wrap(a,c);return d.methodName="$logCompletionWrapper::"+b,d.originalFunction=a,d},logCalls:function(a,b){var c=a,d=function(d){var f=Array.prototype.slice.call(arguments);return f.shift(),e=d.apply(a,f),b?console.warn("%s(%s) -> %s",fun.qualifiedMethodName(c),f,e):console.log("%s(%s) -> %s",fun.qualifiedMethodName(c),f,e),e};d.methodName="$logCallsAdvice::"+fun.qualifiedMethodName(a);var e=fun.wrap(a,d);return e.originalFunction=a,e.methodName="$logCallsWrapper::"+fun.qualifiedMethodName(a),e},traceCalls:function(a,b){var c=function(c){var d=Array.prototype.slice.call(arguments);d.shift(),b.push(d);var e=c.apply(a,d);return b.pop(),e};return fun.wrap(a,c)},webkitStack:function(){try{throw new Error}catch(a){return String(a.stack).split(/\n/).slice(2).map(function(a){return a.replace(/^\s*at\s*([^\s]+).*/,"$1")}).join("\n")}}};exports.Closure=Closure,exports.obj.extend(Closure,{superclass:Object,type:"Closure",categories:{}}),Closure.prototype.isLivelyClosure=!0,Closure.prototype.doNotSerialize=["originalFunc"],Closure.prototype.initialize=function(a,b,c,d){this.originalFunc=a,this.varMapping=b||{},this.source=c,this.setFuncProperties(a||d)},Closure.prototype.setFuncSource=function(a){this.source=a},Closure.prototype.getFuncSource=function(){return this.source||String(this.originalFunc)},Closure.prototype.hasFuncSource=function(){return this.source&&!0},Closure.prototype.getFunc=function(){return this.originalFunc||this.recreateFunc()},Closure.prototype.getFuncProperties=function(){return this.funcProperties||(this.funcProperties={}),this.funcProperties},Closure.prototype.setFuncProperties=function(a){var b=this.getFuncProperties();for(var c in a)a.hasOwnProperty(c)&&"_cachedAst"!=c&&(b[c]=a[c])},Closure.prototype.lookup=function(a){return this.varMapping[a]},Closure.prototype.parameterNames=function(a){var b=/function\s*\(([^\)]*)\)/,c=b.exec(a);if(!c||!c[1])return[];var d=c[1];if(0==d.length)return[];var e=d.split(",").map(function(a){return exports.string.removeSurroundingWhitespaces(a)},this);return e},Closure.prototype.firstParameter=function(a){return this.parameterNames(a)[0]||null},Closure.prototype.recreateFunc=function(){return this.recreateFuncFromSource(this.getFuncSource(),this.originalFunc)},Closure.prototype.recreateFuncFromSource=function(a,b){var c=[],d=!1,e="$super"===this.firstParameter(a);for(var f in this.varMapping)this.varMapping.hasOwnProperty(f)&&("this"!=f?c.push(f+'=this.varMapping["'+f+'"]'):d=!0);var g=c.length>0?"var "+c.join(",")+";\n":"";if(e&&(g+="(function superWrapperForClosure() { return "),g+="("+a+")",e&&(g+=".apply(this, [$super.bind(this)].concat(Array.from(arguments))) })"),"undefined"!=typeof lively&&lively.Config&&lively.Config.get("loadRewrittenCode")){module("lively.ast.Rewriting").load(!0);var h="[runtime]";b&&b.sourceModule&&(h=new URL(b.sourceModule.findUri()).relativePathFrom(URL.root));var i=lively.ast.acorn.parse(g),j=lively.ast.Rewriting.rewrite(i,lively.ast.Rewriting.getCurrentASTRegistry(),h),k=j.body[0].block.body.last();k.type="ReturnStatement",k.argument=k.expression,delete k.expression,g="(function() { "+escodegen.generate(j)+"}).bind(this)();"}try{var l=fun.evalJS.call(this,g)||this.couldNotCreateFunc(g);return this.addFuncProperties(l),this.originalFunc=l,"undefined"!=typeof lively&&lively.Config&&lively.Config.get("loadRewrittenCode")&&(l._cachedAst.source=a,l._cachedAst.start++,l._cachedAst.end--),l}catch(m){var n="Cannot create function "+m+" src: "+g;throw console.error(n),new Error(n)}},Closure.prototype.addFuncProperties=function(a){var b=this.getFuncProperties();for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);this.addClosureInformation(a)},Closure.prototype.couldNotCreateFunc=function(a){var b="Could not recreate closure from source: \n"+a;return console.error(b),function(){throw new Error(b)}},Closure.prototype.asFunction=function(){return this.recreateFunc()},Closure.prototype.addClosureInformation=function(a){return a.hasLivelyClosure=!0,a.livelyClosure=this,a},Closure.fromFunction=function(a,b){return new Closure(a,b||{})},Closure.fromSource=function(a,b){return new Closure(null,b||{},a)}}("undefined"!=typeof lively&&lively.lang?lively.lang:require("./base")),function(a){var b=a.string={format:function(){return b.formatFromArray(Array.prototype.slice.call(arguments))},formatFromArray:function(b){function c(a){return""+a}function d(a){return a.toString()}function e(a,b,c){return c>-1?a.toFixed(c):a.toString()}function f(b){return a.obj.inspect(b)}function g(a){for(var b=[],c=j.exec(a);c;c=j.exec(a)){var d=c[8]||c[5],e=d in i?i[d]:f,g=c[3]?parseInt(c[3]):"."==c[4]?-1:0;b.push(a.substr(0,"%"==c[0][0]?c.index:c.index+1)),b.push({appender:e,precision:g}),a=a.substr(c.index+c[0].length)}return a&&b.push(a.toString()),b}var h=b.shift();h||console.log("Error in Strings>>formatFromArray, first arg is undefined");for(var i={s:c,d:d,i:d,f:e,o:f},j=/((^%|[^\\]%)(\d+)?(\.)([a-zA-Z]))|((^%|[^\\]%)([a-zA-Z]))/,k=g(h),l="",m=0,n=0;n<k.length;++n){var o=k[n];if(o&&"object"==typeof o){var p=b[m++];l+=(o.appender||c)(p,l,o.precision)}else l+=c(o,l)}return l},indent:function(a,b,c){if(!c||0>=c)return a;for(;c>0;)c--,a=b+a;return a},removeSurroundingWhitespaces:function(a){function b(a){for(;a.length>0&&/\s|\n|\r/.test(a[a.length-1]);)a=a.substring(0,a.length-1);return a}function c(a){return a.replace(/^[\n\s]*(.*)/,"$1")}return c(b(a))},quote:function(a){return'"'+a.replace(/"/g,'\\"')+'"'},print:function c(a){if(a&&Array.isArray(a))return"["+a.map(c)+"]";if("string"!=typeof a)return String(a);var b=String(a);return b=b.replace(/\n/g,"\\n\\\n"),b=b.replace(/(")/g,"\\$1"),b='"'+b+'"'},printNested:function(a,c){c=c||0;var d="";return a.forEach(function(a){d+=a instanceof Array?b.printNested(a,c+1):b.indent(a+"\n","  ",c)}),d},pad:function(a,b,c){return c?" ".times(b)+a:a+" ".times(b)},printTable:function(a,c){function d(a){return g?!1:h?!0:c&&Object.isArray(c.align)&&"right"===c.align[a]}var e=[],f=c&&c.separator||" ",g=!c||!c.align||"left"===c.align,h=c&&"right"===c.align;return a.forEach(function(a){a.forEach(function(a,b){void 0===e[b]&&(e[b]=0),e[b]=Math.max(e[b],String(a).length)})}),a.collect(function(a){return a.collect(function(a,c){var f=String(a);return b.pad(f,e[c]-f.length,d(c))}).join(f)}).join("\n")},printTree:function(a,c,d,e){function f(a,h,i){g[h]=b.times(e,a)+c(i,a);var j=d(i,a),k=h+1;if(!j||!j.length)return k;var l=k,m=j.length-1;return j.forEach(function(b,c){k=f(a+1,k,b);for(var d=m===c,h=g[l].split(""),i=a*e.length+1,j=a*e.length+e.length,c=i;j>c;c++)h[c]="-";d&&(h[a*e.length]="\\"),g[l]=h.join(""),d||g.slice(l,k).forEach(function(b,c){var d=b.split("");d[a*e.length]="|",g[l+c]=d.join("")}),l=k}),k}var g=[];return e=e||"  ",f(0,0,a),g.join("\n")},toArray:function(a){return a.split("")},lines:function(a){return a.split(/\n\r?/)},paragraphs:function(a,b){function c(a){return/^\s*$/.test(a)}var d=b?b.sep:"\n\n";return b&&b.keepEmptyLines?a.split("\n").concat("").reduce(function(a,b){var d=a[0],e=a[1];return c(e)===c(b)?e+="\n"+b:(e.length&&d.push(e),e=b),[d,e]},[[],""])[0]:a.split(new RegExp(d+"+"))},nonEmptyLines:function(a){return b.lines(a).compact()},tokens:function(a,b){return a.split(b||/\s+/).filter(function(a){return!/^\s*$/.test(a)})},tableize:function(a,c){c=c||{};for(var d=c.cellSplitter||/\s+/,e=/^\s*$/,f=c.hasOwnProperty("convertTypes")?!!c.convertTypes:!0,g=b.lines(a),h=[],i=0;i<g.length;i++){var j=b.tokens(g[i],d);f&&(j=j.map(function(a){if(a.match(e))return a;var b=Number(a);if(!isNaN(b))return b;var c=new Date(a);return isNaN(+c)?a.trim():c})),j.length>0&&h.push(j)}return h},unescapeCharacterEntities:function(a){if("undefined"==typeof document)throw new Error("Cannot unescapeCharacterEntities");var b=document.createElement("div");return b.innerHTML=a,b.textContent},toQueryParams:function(a,b){var c=a.trim().match(/([^?#]*)(#.*)?$/);if(!c)return{};var d=c[1].split(b||"&").inject({},function(a,b){if((b=b.split("="))[0]){var c=decodeURIComponent(b.shift()),d=b.length>1?b.join("="):b[0];void 0!=d&&(d=decodeURIComponent(d)),c in a?(Array.isArray(a[c])||(a[c]=[a[c]]),a[c].push(d)):a[c]=d}return a});return d},joinPath:function(){var a=Array.prototype.slice.call(arguments);return a.reduce(function(a,b){return"string"==typeof b?a.replace(/\/*$/,"")+"/"+b.replace(/^\/*/,""):a})},newUUID:function(){var a="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)}).toUpperCase();return a},createDataURI:function(a,b){return b=b||"text/plain","data:"+b+";base64,"+btoa(a)},hashCode:function(a){var b=0,c=a.length;if(0==c)return b;for(var d=0;c>d;d++){var e=a.charCodeAt(d);b=(b<<5)-b+e,b&=b}return b},md5:function(a){function b(a,b,c,d,e,f){return b=l(l(b,a),l(d,f)),l(b<<e|b>>>32-e,c)}function c(a,c,d,e,f,g,h){return b(c&d|~c&e,a,c,f,g,h)}function d(a,c,d,e,f,g,h){return b(c&e|d&~e,a,c,f,g,h)}function e(a,c,d,e,f,g,h){return b(c^d^e,a,c,f,g,h)}function f(a,c,d,e,f,g,h){return b(d^(c|~e),a,c,f,g,h)}function g(a,b){var g=a[0],h=a[1],i=a[2],j=a[3];g=c(g,h,i,j,b[0],7,-680876936),j=c(j,g,h,i,b[1],12,-389564586),i=c(i,j,g,h,b[2],17,606105819),h=c(h,i,j,g,b[3],22,-1044525330),g=c(g,h,i,j,b[4],7,-176418897),j=c(j,g,h,i,b[5],12,1200080426),i=c(i,j,g,h,b[6],17,-1473231341),h=c(h,i,j,g,b[7],22,-45705983),g=c(g,h,i,j,b[8],7,1770035416),j=c(j,g,h,i,b[9],12,-1958414417),i=c(i,j,g,h,b[10],17,-42063),h=c(h,i,j,g,b[11],22,-1990404162),g=c(g,h,i,j,b[12],7,1804603682),j=c(j,g,h,i,b[13],12,-40341101),i=c(i,j,g,h,b[14],17,-1502002290),h=c(h,i,j,g,b[15],22,1236535329),g=d(g,h,i,j,b[1],5,-165796510),j=d(j,g,h,i,b[6],9,-1069501632),i=d(i,j,g,h,b[11],14,643717713),h=d(h,i,j,g,b[0],20,-373897302),g=d(g,h,i,j,b[5],5,-701558691),j=d(j,g,h,i,b[10],9,38016083),i=d(i,j,g,h,b[15],14,-660478335),h=d(h,i,j,g,b[4],20,-405537848),g=d(g,h,i,j,b[9],5,568446438),j=d(j,g,h,i,b[14],9,-1019803690),i=d(i,j,g,h,b[3],14,-187363961),h=d(h,i,j,g,b[8],20,1163531501),g=d(g,h,i,j,b[13],5,-1444681467),j=d(j,g,h,i,b[2],9,-51403784),i=d(i,j,g,h,b[7],14,1735328473),h=d(h,i,j,g,b[12],20,-1926607734),g=e(g,h,i,j,b[5],4,-378558),j=e(j,g,h,i,b[8],11,-2022574463),i=e(i,j,g,h,b[11],16,1839030562),h=e(h,i,j,g,b[14],23,-35309556),g=e(g,h,i,j,b[1],4,-1530992060),j=e(j,g,h,i,b[4],11,1272893353),i=e(i,j,g,h,b[7],16,-155497632),h=e(h,i,j,g,b[10],23,-1094730640),g=e(g,h,i,j,b[13],4,681279174),j=e(j,g,h,i,b[0],11,-358537222),i=e(i,j,g,h,b[3],16,-722521979),h=e(h,i,j,g,b[6],23,76029189),g=e(g,h,i,j,b[9],4,-640364487),j=e(j,g,h,i,b[12],11,-421815835),i=e(i,j,g,h,b[15],16,530742520),h=e(h,i,j,g,b[2],23,-995338651),g=f(g,h,i,j,b[0],6,-198630844),j=f(j,g,h,i,b[7],10,1126891415),i=f(i,j,g,h,b[14],15,-1416354905),h=f(h,i,j,g,b[5],21,-57434055),g=f(g,h,i,j,b[12],6,1700485571),j=f(j,g,h,i,b[3],10,-1894986606),i=f(i,j,g,h,b[10],15,-1051523),h=f(h,i,j,g,b[1],21,-2054922799),g=f(g,h,i,j,b[8],6,1873313359),j=f(j,g,h,i,b[15],10,-30611744),i=f(i,j,g,h,b[6],15,-1560198380),h=f(h,i,j,g,b[13],21,1309151649),g=f(g,h,i,j,b[4],6,-145523070),j=f(j,g,h,i,b[11],10,-1120210379),i=f(i,j,g,h,b[2],15,718787259),h=f(h,i,j,g,b[9],21,-343485551),a[0]=l(g,a[0]),a[1]=l(h,a[1]),a[2]=l(i,a[2]),a[3]=l(j,a[3])}function h(a){var b,c=a.length,d=[1732584193,-271733879,-1732584194,271733878];for(b=64;c>=b;b+=64)g(d,i(a.substring(b-64,b)));a=a.substring(b-64);var e=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],f=a.length;for(b=0;f>b;b++)e[b>>2]|=a.charCodeAt(b)<<(b%4<<3);if(e[b>>2]|=128<<(b%4<<3),b>55)for(g(d,e),b=16;b--;)e[b]=0;return e[14]=8*c,g(d,e),d}function i(a){var b,c=[];for(b=0;64>b;b+=4)c[b>>2]=a.charCodeAt(b)+(a.charCodeAt(b+1)<<8)+(a.charCodeAt(b+2)<<16)+(a.charCodeAt(b+3)<<24);return c}function j(a){for(var b="",c=0;4>c;c++)b+=m[a>>8*c+4&15]+m[a>>8*c&15];return b}function k(a){for(var b=a.length,c=0;b>c;c++)a[c]=j(a[c]);return a.join("")}var l=function(a,b){var c=(65535&a)+(65535&b),d=(a>>16)+(b>>16)+(c>>16);return d<<16|65535&c},m="0123456789abcdef".split("");return k(h(a))},reMatches:function(a,b){var c=[];return a.replace(b,function(a,b){c.push({match:a,start:b,end:b+a.length})}),c},stringMatch:function(c,d,e){function f(a,b,c,d,e){return d=d||0,e=e||0,[a.slice(0,b),a.slice(b+d,c-e),a.slice(c)]}function g(a,c){if(c.constructor!==RegExp){var d=a.indexOf(c);if(0===d)return{match:c,rest:a.slice(c.length)};for(var e=0;e<c.length;e++)if(c[e]!=a[e])return{match:null,pos:e};return{match:null}}var f=b.reMatches(a,c);return f&&f.length&&0===f[0].start?{match:f[0].match,rest:a.slice(f[0].end)}:{match:null}}function h(a,b){for(var c=0,d=0;d<b.length;d++){var e=b[d],f=g(a,e);if(!f.match)return{matched:!1,pos:c+(f.pos||0),pattern:e};c+=f.match.length,a=f.rest}return a.length?{matched:!1,pos:c}:{matched:!0}}function i(c){var d=b.reMatches(c,/__\//g),e=b.reMatches(c,/\/__/g);if(d.length!==e.length)throw new Error("pattern invalid: "+c+" cannot be split into __/.../__ embedded RegExps\nstarts: "+JSON.stringify(d)+"\nvs ends:\n"+JSON.stringify(e));var g=0;return d.reduce(function(b,c,d){var h=e[d],i=b.pop(),j=f(i,c.start-g,h.end-g,3,3);j[0].length&&(b.push(j[0]),g+=j[0].length);try{j[1].length&&(b.push(new RegExp(j[1])),g+=j[1].length+3+3)}catch(k){throw new Error("Cannot create pattern re from: "+a.obj.inspect(j))}return j[2].length&&b.push(j[2]),b},[c])}function j(a,b){var c=i(b),d=h(a,c);return d.matched?d:(d.error=a.slice(0,d.pos)+"<--UNMATCHED-->"+a.slice(d.pos),d)}return e=e||{},e.normalizeWhiteSpace&&(c=c.replace(/\s+/g," ")),e.ignoreIndent&&(c=c.replace(/^\s+/gm,""),d=d.replace(/^\s+/gm,"")),c==d?{matched:!0}:j(c,d)},peekRight:function(a,c,d){if(a=a.slice(c),"string"==typeof d){var e=a.indexOf(d);return-1===e?null:e+c}if(d.constructor===RegExp){var f=b.reMatches(a,d);return f[0]?f[0].start:null}return null},peekLeft:function(c,d,e){if(c=c.slice(0,d),"string"==typeof e){var f=c.lastIndexOf(e);return-1===f?null:f}if(e.constructor===RegExp){var g=b.reMatches(c,e);return a.arr.last(g)?a.arr.last(g).start:null}return null},lineIndexComputer:function(a){var c=b.lines(a).reduce(function(a,b){var c=a.slice(-1)[0]||-1;return a.concat([c+1,c+1+b.length])},[]);return function(a){for(var b=0;b<c.length;b+=2)if(a>=c[b]&&a<=c[b+1])return b/2;return-1}},lineNumberToIndexesComputer:function(a){var c=b.lines(a).reduce(function(a,b){var c=a.indexCount,d=a.indexCount+b.length+1;return a.lineRanges.push([c,d]),a.indexCount=d,a},{lineRanges:[],indexCount:0}).lineRanges;return function(a){return c[a]}},diff:function(a,b){return"undefined"==typeof JsDiff?"diff not supported":JsDiff.convertChangesToXML(JsDiff.diffWordsWithSpace(a,b))},empty:function(a){return""==a},include:function(a,b){return a.indexOf(b)>-1},startsWith:function(a,b){return 0===a.indexOf(b)},startsWithVowel:function(a){var b=a[0];return"A"===b||"E"===b||"I"===b||"O"===b||"U"===b||"a"===b||"e"===b||"i"===b||"o"===b||"u"===b||!1},endsWith:function(a,b){var c=a.length-b.length;return c>=0&&a.lastIndexOf(b)===c},withDecimalPrecision:function(a,b){var c=parseFloat(a);return isNaN(c)?a:c.toFixed(b)},capitalize:function(a){return a.length?a.charAt(0).toUpperCase()+a.slice(1):a},camelCaseString:function(a){return a.split(" ").invoke("capitalize").join("")},camelize:function(a){var b=a.split("-"),c=b.length;if(1==c)return b[0];for(var d="-"==a.charAt(0)?b[0].charAt(0).toUpperCase()+b[0].substring(1):b[0],e=1;c>e;e++)d+=b[e].charAt(0).toUpperCase()+b[e].substring(1);return d},truncate:function(a,b,c){return b=b||30,c=void 0===c?"...":c,a.length>b?a.slice(0,b-c.length)+c:String(a)},regExpEscape:function(a){return a.replace(/([-()\[\]{}+?*.$\^|,:#<!\\])/g,"\\$1").replace(/\x08/g,"\\x08")},succ:function(a){return a.slice(0,a.length-1)+String.fromCharCode(a.charCodeAt(a.length-1)+1)},digitValue:function(){return this.charCodeAt(0)-"0".charCodeAt(0)},times:function(a,b){return 1>b?"":new Array(b+1).join(a)}}}("undefined"!=typeof lively&&lively.lang?lively.lang:require("./base")),function(a){"use strict";a.num={random:function(a,b){return a=a||0,b=b||100,Math.round(Math.random()*(b-a)+a)},normalRandom:function(){var a,b=!1;return function(c,d){if(b)return b=!1,a*d+c;var e,f,g;do e=2*Math.random()-1,f=2*Math.random()-1,g=e*e+f*f;while(g>=1||0==g);var h=Math.sqrt(-2*Math.log(g)/g);return a=f*h,b=!0,c+d*e*h}}(),randomSmallerInteger:function(a){return Math.floor(Math.random()*a)},humanReadableByteSize:function(a){function b(a){return Math.round(100*a)/100}return 1e3>a?String(b(a))+"B":(a/=1024,1e3>a?String(b(a))+"KB":(a/=1024,String(b(a))+"MB"))},average:function(a){return a.reduce(function(a,b){return a+b},0)/a.length},median:function(a){var b=a.sort(function(a,b){return b-a}),c=a.length;return c%2===0?.5*(b[c/2-1]+b[c/2]):b[(c-1)/2]},between:function(a,b,c,d){d=d||0;var e,f;return c>b?(e=b,f=c):(f=b,e=c),f-a+d>=0&&0>=e-a-d},sort:function(a){return a.sort(function(a,b){return a-b})},parseLength:function(b,c){c=c||"px";var d=b.match(/([0-9\.]+)\s*(.*)/);if(!d||!d[1])return void 0;var e=parseFloat(d[1]),f=d[2];return a.num.convertLength(e,f,c)},convertLength:function(){function a(b,c){return"cm"===c?b:"mm"===c?.1*b:"in"===c?2.54*b:"px"===c?b*a(1/96,"in"):"pt"===c?b*a(1/72,"in"):"pc"===c?b*a(12,"pt"):void 0}return function b(c,d,e){return d===e?c:"cm"===e?a(c,d):"cm"===d?c/a(1,e):b(b(c,d,"cm"),"cm",e)}}(),roundTo:function(a,b){return b=1/b,Math.round(a*b)/b},detent:function(b,c,d,e){var f=a.num.roundTo(b,d);if(Math.abs(b-f)<c/2)return f;if(e)return b;var g=f>b?f-c/2:f+c/2;return f+(b-g)*d/(d-c)},toDegrees:function(a){return 180*a/Math.PI%360},toRadians:function(a){return a/180*Math.PI}}}("undefined"!=typeof lively&&lively.lang?lively.lang:require("./base")),function(a){"use strict";var b=function(){var a=function(){var b=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,c=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,d=/[^-+\dA-Z]/g,e=function(a,b){for(a=String(a),b=b||2;a.length<b;)a="0"+a;return a};return function(f,g,h){var i=a;if(1!=arguments.length||"[object String]"!=Object.prototype.toString.call(f)||/\d/.test(f)||(g=f,f=void 0),f=f?new Date(f):new Date,isNaN(f))throw SyntaxError("invalid date");g=String(i.masks[g]||g||i.masks["default"]),"UTC:"==g.slice(0,4)&&(g=g.slice(4),h=!0);var j=h?"getUTC":"get",k=f[j+"Date"](),l=f[j+"Day"](),m=f[j+"Month"](),n=f[j+"FullYear"](),o=f[j+"Hours"](),p=f[j+"Minutes"](),q=f[j+"Seconds"](),r=f[j+"Milliseconds"](),s=h?0:f.getTimezoneOffset(),t={d:k,dd:e(k),ddd:i.i18n.dayNames[l],dddd:i.i18n.dayNames[l+7],m:m+1,mm:e(m+1),mmm:i.i18n.monthNames[m],mmmm:i.i18n.monthNames[m+12],yy:String(n).slice(2),yyyy:n,h:o%12||12,hh:e(o%12||12),H:o,HH:e(o),M:p,MM:e(p),s:q,ss:e(q),l:e(r,3),L:e(r>99?Math.round(r/10):r),t:12>o?"a":"p",tt:12>o?"am":"pm",T:12>o?"A":"P",TT:12>o?"AM":"PM",Z:h?"UTC":(String(f).match(c)||[""]).pop().replace(d,""),o:(s>0?"-":"+")+e(100*Math.floor(Math.abs(s)/60)+Math.abs(s)%60,4),S:["th","st","nd","rd"][k%10>3?0:(k%100-k%10!=10)*k%10]};return g.replace(b,function(a){return a in t?t[a]:a.slice(1,a.length-1)})}}();return a.masks={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"},a.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]},a}();a.date={format:function(){return b}(),equals:function(a,b){return b&&b instanceof Date&&b.getTime()===a.getTime()
},relativeTo:function(a,b){if(!(b instanceof Date))return"";if(a>b)return"";if(b===a)return"now";var c="min",d="sec",e="hour",f="day",g=b-a,h=Math.round(g/1e3),i=h%60,j=Math.floor(h/60)%60,k=Math.floor(h/60/60)%24,l=Math.floor(h/60/60/24),m=[];return l>0&&(m.push(l),l>1&&(f+="s"),m.push(f)),k>0&&2>l&&(m.push(k),k>1&&(e+="s"),m.push(e)),j>0&&3>k&&0===l&&(m.push(j),j>1&&(c+="s"),m.push(c)),i>0&&3>j&&0===k&&0===l&&(m.push(i),i>1&&(d+="s"),m.push(d)),m.join(" ")}}}("undefined"!=typeof lively&&lively.lang?lively.lang:require("./base")),function(exports){"use strict";var isNode="undefined"!=typeof process&&process.versions&&process.versions.node,Global="undefined"!=typeof window?window:global,classHelper=exports.classHelper={anonymousCounter:0,defaultCategoryName:"default category",initializerTemplate:"undefined"!=typeof lively&&lively.Config&&lively.Config.loadRewrittenCode?function(){classHelper.initializer.apply(this,arguments)}.toStringRewritten().replace(/__0/g,"Global").replace(/__1/g,"__1"):function(){classHelper.initializer.apply(this,arguments)}.toString(),newInitializer:function(name){var src=classHelper.initializerTemplate.replace(/function\s*(CLASS)?\(\)/,"function "+name+"()");if("undefined"!=typeof lively&&lively.Config&&lively.Config.loadRewrittenCode){var idx=src.match(".*storeFrameInfo([^)]*, ([0-9]+))")[2];src='__createClosure("core/lively/Base.js", '+idx+", Global, "+src+");"}else src+=" "+name;var initializer=eval(src);return initializer.displayName=name,initializer},initializer:function(){var a=arguments[0];a&&a.isInstanceRestorer||this.initialize.apply(this,arguments)},isValidIdentifier:function(){var a=/^(?!(?:do|if|in|for|let|new|try|var|case|else|enum|eval|false|null|this|true|void|with|break|catch|class|const|super|throw|while|yield|delete|export|import|public|return|static|switch|typeof|extends|finally|package|private|continue|debugger|function|arguments|interface|protected|implements|instanceof)$)[$A-Z\_a-z\xaa\xb5\xba\xc0-\xd6\xd8-\xf6\xf8-\u02c1\u02c6-\u02d1\u02e0-\u02e4\u02ec\u02ee\u0370-\u0374\u0376\u0377\u037a-\u037d\u0386\u0388-\u038a\u038c\u038e-\u03a1\u03a3-\u03f5\u03f7-\u0481\u048a-\u0527\u0531-\u0556\u0559\u0561-\u0587\u05d0-\u05ea\u05f0-\u05f2\u0620-\u064a\u066e\u066f\u0671-\u06d3\u06d5\u06e5\u06e6\u06ee\u06ef\u06fa-\u06fc\u06ff\u0710\u0712-\u072f\u074d-\u07a5\u07b1\u07ca-\u07ea\u07f4\u07f5\u07fa\u0800-\u0815\u081a\u0824\u0828\u0840-\u0858\u08a0\u08a2-\u08ac\u0904-\u0939\u093d\u0950\u0958-\u0961\u0971-\u0977\u0979-\u097f\u0985-\u098c\u098f\u0990\u0993-\u09a8\u09aa-\u09b0\u09b2\u09b6-\u09b9\u09bd\u09ce\u09dc\u09dd\u09df-\u09e1\u09f0\u09f1\u0a05-\u0a0a\u0a0f\u0a10\u0a13-\u0a28\u0a2a-\u0a30\u0a32\u0a33\u0a35\u0a36\u0a38\u0a39\u0a59-\u0a5c\u0a5e\u0a72-\u0a74\u0a85-\u0a8d\u0a8f-\u0a91\u0a93-\u0aa8\u0aaa-\u0ab0\u0ab2\u0ab3\u0ab5-\u0ab9\u0abd\u0ad0\u0ae0\u0ae1\u0b05-\u0b0c\u0b0f\u0b10\u0b13-\u0b28\u0b2a-\u0b30\u0b32\u0b33\u0b35-\u0b39\u0b3d\u0b5c\u0b5d\u0b5f-\u0b61\u0b71\u0b83\u0b85-\u0b8a\u0b8e-\u0b90\u0b92-\u0b95\u0b99\u0b9a\u0b9c\u0b9e\u0b9f\u0ba3\u0ba4\u0ba8-\u0baa\u0bae-\u0bb9\u0bd0\u0c05-\u0c0c\u0c0e-\u0c10\u0c12-\u0c28\u0c2a-\u0c33\u0c35-\u0c39\u0c3d\u0c58\u0c59\u0c60\u0c61\u0c85-\u0c8c\u0c8e-\u0c90\u0c92-\u0ca8\u0caa-\u0cb3\u0cb5-\u0cb9\u0cbd\u0cde\u0ce0\u0ce1\u0cf1\u0cf2\u0d05-\u0d0c\u0d0e-\u0d10\u0d12-\u0d3a\u0d3d\u0d4e\u0d60\u0d61\u0d7a-\u0d7f\u0d85-\u0d96\u0d9a-\u0db1\u0db3-\u0dbb\u0dbd\u0dc0-\u0dc6\u0e01-\u0e30\u0e32\u0e33\u0e40-\u0e46\u0e81\u0e82\u0e84\u0e87\u0e88\u0e8a\u0e8d\u0e94-\u0e97\u0e99-\u0e9f\u0ea1-\u0ea3\u0ea5\u0ea7\u0eaa\u0eab\u0ead-\u0eb0\u0eb2\u0eb3\u0ebd\u0ec0-\u0ec4\u0ec6\u0edc-\u0edf\u0f00\u0f40-\u0f47\u0f49-\u0f6c\u0f88-\u0f8c\u1000-\u102a\u103f\u1050-\u1055\u105a-\u105d\u1061\u1065\u1066\u106e-\u1070\u1075-\u1081\u108e\u10a0-\u10c5\u10c7\u10cd\u10d0-\u10fa\u10fc-\u1248\u124a-\u124d\u1250-\u1256\u1258\u125a-\u125d\u1260-\u1288\u128a-\u128d\u1290-\u12b0\u12b2-\u12b5\u12b8-\u12be\u12c0\u12c2-\u12c5\u12c8-\u12d6\u12d8-\u1310\u1312-\u1315\u1318-\u135a\u1380-\u138f\u13a0-\u13f4\u1401-\u166c\u166f-\u167f\u1681-\u169a\u16a0-\u16ea\u16ee-\u16f0\u1700-\u170c\u170e-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176c\u176e-\u1770\u1780-\u17b3\u17d7\u17dc\u1820-\u1877\u1880-\u18a8\u18aa\u18b0-\u18f5\u1900-\u191c\u1950-\u196d\u1970-\u1974\u1980-\u19ab\u19c1-\u19c7\u1a00-\u1a16\u1a20-\u1a54\u1aa7\u1b05-\u1b33\u1b45-\u1b4b\u1b83-\u1ba0\u1bae\u1baf\u1bba-\u1be5\u1c00-\u1c23\u1c4d-\u1c4f\u1c5a-\u1c7d\u1ce9-\u1cec\u1cee-\u1cf1\u1cf5\u1cf6\u1d00-\u1dbf\u1e00-\u1f15\u1f18-\u1f1d\u1f20-\u1f45\u1f48-\u1f4d\u1f50-\u1f57\u1f59\u1f5b\u1f5d\u1f5f-\u1f7d\u1f80-\u1fb4\u1fb6-\u1fbc\u1fbe\u1fc2-\u1fc4\u1fc6-\u1fcc\u1fd0-\u1fd3\u1fd6-\u1fdb\u1fe0-\u1fec\u1ff2-\u1ff4\u1ff6-\u1ffc\u2071\u207f\u2090-\u209c\u2102\u2107\u210a-\u2113\u2115\u2119-\u211d\u2124\u2126\u2128\u212a-\u212d\u212f-\u2139\u213c-\u213f\u2145-\u2149\u214e\u2160-\u2188\u2c00-\u2c2e\u2c30-\u2c5e\u2c60-\u2ce4\u2ceb-\u2cee\u2cf2\u2cf3\u2d00-\u2d25\u2d27\u2d2d\u2d30-\u2d67\u2d6f\u2d80-\u2d96\u2da0-\u2da6\u2da8-\u2dae\u2db0-\u2db6\u2db8-\u2dbe\u2dc0-\u2dc6\u2dc8-\u2dce\u2dd0-\u2dd6\u2dd8-\u2dde\u2e2f\u3005-\u3007\u3021-\u3029\u3031-\u3035\u3038-\u303c\u3041-\u3096\u309d-\u309f\u30a1-\u30fa\u30fc-\u30ff\u3105-\u312d\u3131-\u318e\u31a0-\u31ba\u31f0-\u31ff\u3400-\u4db5\u4e00-\u9fcc\ua000-\ua48c\ua4d0-\ua4fd\ua500-\ua60c\ua610-\ua61f\ua62a\ua62b\ua640-\ua66e\ua67f-\ua697\ua6a0-\ua6ef\ua717-\ua71f\ua722-\ua788\ua78b-\ua78e\ua790-\ua793\ua7a0-\ua7aa\ua7f8-\ua801\ua803-\ua805\ua807-\ua80a\ua80c-\ua822\ua840-\ua873\ua882-\ua8b3\ua8f2-\ua8f7\ua8fb\ua90a-\ua925\ua930-\ua946\ua960-\ua97c\ua984-\ua9b2\ua9cf\uaa00-\uaa28\uaa40-\uaa42\uaa44-\uaa4b\uaa60-\uaa76\uaa7a\uaa80-\uaaaf\uaab1\uaab5\uaab6\uaab9-\uaabd\uaac0\uaac2\uaadb-\uaadd\uaae0-\uaaea\uaaf2-\uaaf4\uab01-\uab06\uab09-\uab0e\uab11-\uab16\uab20-\uab26\uab28-\uab2e\uabc0-\uabe2\uac00-\ud7a3\ud7b0-\ud7c6\ud7cb-\ud7fb\uf900-\ufa6d\ufa70-\ufad9\ufb00-\ufb06\ufb13-\ufb17\ufb1d\ufb1f-\ufb28\ufb2a-\ufb36\ufb38-\ufb3c\ufb3e\ufb40\ufb41\ufb43\ufb44\ufb46-\ufbb1\ufbd3-\ufd3d\ufd50-\ufd8f\ufd92-\ufdc7\ufdf0-\ufdfb\ufe70-\ufe74\ufe76-\ufefc\uff21-\uff3a\uff41-\uff5a\uff66-\uffbe\uffc2-\uffc7\uffca-\uffcf\uffd2-\uffd7\uffda-\uffdc][$A-Z\_a-z\xaa\xb5\xba\xc0-\xd6\xd8-\xf6\xf8-\u02c1\u02c6-\u02d1\u02e0-\u02e4\u02ec\u02ee\u0370-\u0374\u0376\u0377\u037a-\u037d\u0386\u0388-\u038a\u038c\u038e-\u03a1\u03a3-\u03f5\u03f7-\u0481\u048a-\u0527\u0531-\u0556\u0559\u0561-\u0587\u05d0-\u05ea\u05f0-\u05f2\u0620-\u064a\u066e\u066f\u0671-\u06d3\u06d5\u06e5\u06e6\u06ee\u06ef\u06fa-\u06fc\u06ff\u0710\u0712-\u072f\u074d-\u07a5\u07b1\u07ca-\u07ea\u07f4\u07f5\u07fa\u0800-\u0815\u081a\u0824\u0828\u0840-\u0858\u08a0\u08a2-\u08ac\u0904-\u0939\u093d\u0950\u0958-\u0961\u0971-\u0977\u0979-\u097f\u0985-\u098c\u098f\u0990\u0993-\u09a8\u09aa-\u09b0\u09b2\u09b6-\u09b9\u09bd\u09ce\u09dc\u09dd\u09df-\u09e1\u09f0\u09f1\u0a05-\u0a0a\u0a0f\u0a10\u0a13-\u0a28\u0a2a-\u0a30\u0a32\u0a33\u0a35\u0a36\u0a38\u0a39\u0a59-\u0a5c\u0a5e\u0a72-\u0a74\u0a85-\u0a8d\u0a8f-\u0a91\u0a93-\u0aa8\u0aaa-\u0ab0\u0ab2\u0ab3\u0ab5-\u0ab9\u0abd\u0ad0\u0ae0\u0ae1\u0b05-\u0b0c\u0b0f\u0b10\u0b13-\u0b28\u0b2a-\u0b30\u0b32\u0b33\u0b35-\u0b39\u0b3d\u0b5c\u0b5d\u0b5f-\u0b61\u0b71\u0b83\u0b85-\u0b8a\u0b8e-\u0b90\u0b92-\u0b95\u0b99\u0b9a\u0b9c\u0b9e\u0b9f\u0ba3\u0ba4\u0ba8-\u0baa\u0bae-\u0bb9\u0bd0\u0c05-\u0c0c\u0c0e-\u0c10\u0c12-\u0c28\u0c2a-\u0c33\u0c35-\u0c39\u0c3d\u0c58\u0c59\u0c60\u0c61\u0c85-\u0c8c\u0c8e-\u0c90\u0c92-\u0ca8\u0caa-\u0cb3\u0cb5-\u0cb9\u0cbd\u0cde\u0ce0\u0ce1\u0cf1\u0cf2\u0d05-\u0d0c\u0d0e-\u0d10\u0d12-\u0d3a\u0d3d\u0d4e\u0d60\u0d61\u0d7a-\u0d7f\u0d85-\u0d96\u0d9a-\u0db1\u0db3-\u0dbb\u0dbd\u0dc0-\u0dc6\u0e01-\u0e30\u0e32\u0e33\u0e40-\u0e46\u0e81\u0e82\u0e84\u0e87\u0e88\u0e8a\u0e8d\u0e94-\u0e97\u0e99-\u0e9f\u0ea1-\u0ea3\u0ea5\u0ea7\u0eaa\u0eab\u0ead-\u0eb0\u0eb2\u0eb3\u0ebd\u0ec0-\u0ec4\u0ec6\u0edc-\u0edf\u0f00\u0f40-\u0f47\u0f49-\u0f6c\u0f88-\u0f8c\u1000-\u102a\u103f\u1050-\u1055\u105a-\u105d\u1061\u1065\u1066\u106e-\u1070\u1075-\u1081\u108e\u10a0-\u10c5\u10c7\u10cd\u10d0-\u10fa\u10fc-\u1248\u124a-\u124d\u1250-\u1256\u1258\u125a-\u125d\u1260-\u1288\u128a-\u128d\u1290-\u12b0\u12b2-\u12b5\u12b8-\u12be\u12c0\u12c2-\u12c5\u12c8-\u12d6\u12d8-\u1310\u1312-\u1315\u1318-\u135a\u1380-\u138f\u13a0-\u13f4\u1401-\u166c\u166f-\u167f\u1681-\u169a\u16a0-\u16ea\u16ee-\u16f0\u1700-\u170c\u170e-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176c\u176e-\u1770\u1780-\u17b3\u17d7\u17dc\u1820-\u1877\u1880-\u18a8\u18aa\u18b0-\u18f5\u1900-\u191c\u1950-\u196d\u1970-\u1974\u1980-\u19ab\u19c1-\u19c7\u1a00-\u1a16\u1a20-\u1a54\u1aa7\u1b05-\u1b33\u1b45-\u1b4b\u1b83-\u1ba0\u1bae\u1baf\u1bba-\u1be5\u1c00-\u1c23\u1c4d-\u1c4f\u1c5a-\u1c7d\u1ce9-\u1cec\u1cee-\u1cf1\u1cf5\u1cf6\u1d00-\u1dbf\u1e00-\u1f15\u1f18-\u1f1d\u1f20-\u1f45\u1f48-\u1f4d\u1f50-\u1f57\u1f59\u1f5b\u1f5d\u1f5f-\u1f7d\u1f80-\u1fb4\u1fb6-\u1fbc\u1fbe\u1fc2-\u1fc4\u1fc6-\u1fcc\u1fd0-\u1fd3\u1fd6-\u1fdb\u1fe0-\u1fec\u1ff2-\u1ff4\u1ff6-\u1ffc\u2071\u207f\u2090-\u209c\u2102\u2107\u210a-\u2113\u2115\u2119-\u211d\u2124\u2126\u2128\u212a-\u212d\u212f-\u2139\u213c-\u213f\u2145-\u2149\u214e\u2160-\u2188\u2c00-\u2c2e\u2c30-\u2c5e\u2c60-\u2ce4\u2ceb-\u2cee\u2cf2\u2cf3\u2d00-\u2d25\u2d27\u2d2d\u2d30-\u2d67\u2d6f\u2d80-\u2d96\u2da0-\u2da6\u2da8-\u2dae\u2db0-\u2db6\u2db8-\u2dbe\u2dc0-\u2dc6\u2dc8-\u2dce\u2dd0-\u2dd6\u2dd8-\u2dde\u2e2f\u3005-\u3007\u3021-\u3029\u3031-\u3035\u3038-\u303c\u3041-\u3096\u309d-\u309f\u30a1-\u30fa\u30fc-\u30ff\u3105-\u312d\u3131-\u318e\u31a0-\u31ba\u31f0-\u31ff\u3400-\u4db5\u4e00-\u9fcc\ua000-\ua48c\ua4d0-\ua4fd\ua500-\ua60c\ua610-\ua61f\ua62a\ua62b\ua640-\ua66e\ua67f-\ua697\ua6a0-\ua6ef\ua717-\ua71f\ua722-\ua788\ua78b-\ua78e\ua790-\ua793\ua7a0-\ua7aa\ua7f8-\ua801\ua803-\ua805\ua807-\ua80a\ua80c-\ua822\ua840-\ua873\ua882-\ua8b3\ua8f2-\ua8f7\ua8fb\ua90a-\ua925\ua930-\ua946\ua960-\ua97c\ua984-\ua9b2\ua9cf\uaa00-\uaa28\uaa40-\uaa42\uaa44-\uaa4b\uaa60-\uaa76\uaa7a\uaa80-\uaaaf\uaab1\uaab5\uaab6\uaab9-\uaabd\uaac0\uaac2\uaadb-\uaadd\uaae0-\uaaea\uaaf2-\uaaf4\uab01-\uab06\uab09-\uab0e\uab11-\uab16\uab20-\uab26\uab28-\uab2e\uabc0-\uabe2\uac00-\ud7a3\ud7b0-\ud7c6\ud7cb-\ud7fb\uf900-\ufa6d\ufa70-\ufad9\ufb00-\ufb06\ufb13-\ufb17\ufb1d\ufb1f-\ufb28\ufb2a-\ufb36\ufb38-\ufb3c\ufb3e\ufb40\ufb41\ufb43\ufb44\ufb46-\ufbb1\ufbd3-\ufd3d\ufd50-\ufd8f\ufd92-\ufdc7\ufdf0-\ufdfb\ufe70-\ufe74\ufe76-\ufefc\uff21-\uff3a\uff41-\uff5a\uff66-\uffbe\uffc2-\uffc7\uffca-\uffcf\uffd2-\uffd7\uffda-\uffdc0-9\u0300-\u036f\u0483-\u0487\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u0669\u0670\u06d6-\u06dc\u06df-\u06e4\u06e7\u06e8\u06ea-\u06ed\u06f0-\u06f9\u0711\u0730-\u074a\u07a6-\u07b0\u07c0-\u07c9\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0859-\u085b\u08e4-\u08fe\u0900-\u0903\u093a-\u093c\u093e-\u094f\u0951-\u0957\u0962\u0963\u0966-\u096f\u0981-\u0983\u09bc\u09be-\u09c4\u09c7\u09c8\u09cb-\u09cd\u09d7\u09e2\u09e3\u09e6-\u09ef\u0a01-\u0a03\u0a3c\u0a3e-\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a66-\u0a71\u0a75\u0a81-\u0a83\u0abc\u0abe-\u0ac5\u0ac7-\u0ac9\u0acb-\u0acd\u0ae2\u0ae3\u0ae6-\u0aef\u0b01-\u0b03\u0b3c\u0b3e-\u0b44\u0b47\u0b48\u0b4b-\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b66-\u0b6f\u0b82\u0bbe-\u0bc2\u0bc6-\u0bc8\u0bca-\u0bcd\u0bd7\u0be6-\u0bef\u0c01-\u0c03\u0c3e-\u0c44\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0c66-\u0c6f\u0c82\u0c83\u0cbc\u0cbe-\u0cc4\u0cc6-\u0cc8\u0cca-\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0ce6-\u0cef\u0d02\u0d03\u0d3e-\u0d44\u0d46-\u0d48\u0d4a-\u0d4d\u0d57\u0d62\u0d63\u0d66-\u0d6f\u0d82\u0d83\u0dca\u0dcf-\u0dd4\u0dd6\u0dd8-\u0ddf\u0df2\u0df3\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0e50-\u0e59\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0ed0-\u0ed9\u0f18\u0f19\u0f20-\u0f29\u0f35\u0f37\u0f39\u0f3e\u0f3f\u0f71-\u0f84\u0f86\u0f87\u0f8d-\u0f97\u0f99-\u0fbc\u0fc6\u102b-\u103e\u1040-\u1049\u1056-\u1059\u105e-\u1060\u1062-\u1064\u1067-\u106d\u1071-\u1074\u1082-\u108d\u108f-\u109d\u135d-\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b4-\u17d3\u17dd\u17e0-\u17e9\u180b-\u180d\u1810-\u1819\u18a9\u1920-\u192b\u1930-\u193b\u1946-\u194f\u19b0-\u19c0\u19c8\u19c9\u19d0-\u19d9\u1a17-\u1a1b\u1a55-\u1a5e\u1a60-\u1a7c\u1a7f-\u1a89\u1a90-\u1a99\u1b00-\u1b04\u1b34-\u1b44\u1b50-\u1b59\u1b6b-\u1b73\u1b80-\u1b82\u1ba1-\u1bad\u1bb0-\u1bb9\u1be6-\u1bf3\u1c24-\u1c37\u1c40-\u1c49\u1c50-\u1c59\u1cd0-\u1cd2\u1cd4-\u1ce8\u1ced\u1cf2-\u1cf4\u1dc0-\u1de6\u1dfc-\u1dff\u200c\u200d\u203f\u2040\u2054\u20d0-\u20dc\u20e1\u20e5-\u20f0\u2cef-\u2cf1\u2d7f\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua620-\ua629\ua66f\ua674-\ua67d\ua69f\ua6f0\ua6f1\ua802\ua806\ua80b\ua823-\ua827\ua880\ua881\ua8b4-\ua8c4\ua8d0-\ua8d9\ua8e0-\ua8f1\ua900-\ua909\ua926-\ua92d\ua947-\ua953\ua980-\ua983\ua9b3-\ua9c0\ua9d0-\ua9d9\uaa29-\uaa36\uaa43\uaa4c\uaa4d\uaa50-\uaa59\uaa7b\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uaaeb-\uaaef\uaaf5\uaaf6\uabe3-\uabea\uabec\uabed\uabf0-\uabf9\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\ufe33\ufe34\ufe4d-\ufe4f\uff10-\uff19\uff3f]*$/;return function(b){return a.test(b)}}(),isClass:function(a){return a===Object||a===Array||a===Function||a===String||a===Boolean||a===Date||a===RegExp||a===Number?!0:a instanceof Function&&void 0!==a.superclass},className:function(a){return a===Object?"Object":a===Array?"Array":a===Function?"Function":a===String?"String":a===Boolean?"Boolean":a===Date?"Date":a===RegExp?"RegExp":a===Number?"Number":a.type},forName:function(a){var b=classHelper.namespaceFor(a),c=classHelper.unqualifiedNameFor(a);return b[c]},deleteObjectNamed:function(a){var b=classHelper.namespaceFor(a),c=classHelper.unqualifiedNameFor(a);delete b[c]},unqualifiedNameFor:function(a){var b=a.lastIndexOf("."),c=a.substring(b+1);if(!classHelper.isValidIdentifier(c))throw new Error("not a name "+c);return c},namespaceFor:function(a){var b=a?a.lastIndexOf("."):-1;if(0>b)return Global;var c=a.slice(0,b);if("undefined"!=typeof lively&&lively.module)return lively.module(c);var d=exports.Path(c),e=d.get(Global);return e||d.set(Global,{},!0)},withAllClassNames:function(a,b){for(var c in a)try{classHelper.isClass(a[c])&&b(c)}catch(d){}b("Object"),b("Global")},getConstructor:function(a){var b=a.constructor;return b&&b.getOriginal?b.getOriginal():b},getPrototype:function(a){return this.getConstructor(a).prototype},applyPrototypeMethod:function(a,b,c){var d=this.getPrototype(b);if(!d)throw new Error("method "+a+" not found");return d.apply(this,c)},getSuperConstructor:function(a){return this.getConstructor(a).superclass},getSuperPrototype:function(a){var b=this.getSuperConstructor(a);return b&&b.prototype},addPins:function(a,b){function c(a){return a.replace(/[\+|\-]?(.*)/,"$1")}function d(a){return!exports.string.startsWith(a,"-")}function e(a){return!exports.string.startsWith(a,"+")}if(Global.Relay)return void classHelper.addMixin(a,Relay.newDelegationMixin(b).prototype);if(!Object.isArray(b))throw new Error("Cannot deal with non-Array spec in addPins");var f={};b.forEach(function(a){var b=c(a);d(a)&&(f["set"+b]=function(a){return this["_"+b]=a}),e(a)&&(f["get"+b]=function(){return this["_"+b]})}),classHelper.addMixin(a,f)},addMixin:function(a,b){var c={};for(var d in b){var e=b[d];switch(d){case"constructor":case"initialize":case"deserialize":case"copyFrom":case"toString":case"definition":case"description":break;default:void 0===a.prototype[d]&&(c[d]=e)}}a.addMethods(c)}};exports.class={create:function(){var a,b=exports.arr.from(arguments),c=b.shift(),d=Global,e=null;c&&"string"!=typeof c?a=b.shift():(a=c,c=Object),a?(d=classHelper.namespaceFor(a),e=classHelper.unqualifiedNameFor(a)):(e="anonymous_"+classHelper.anonymousCounter++,a=e);var f;if(a&&d[e]&&d[e].superclass===c)f=d[e];else{f=classHelper.newInitializer(e),f.superclass=c;var g=function(){};g.prototype=c.prototype,f.prototype=new g,f.prototype.constructor=f,f.type=a,f.displayName=a,a&&(d[e]=f),"undefined"!=typeof lively&&lively.Module&&lively.Module.current&&(f.sourceModule=lively.Module.current()),f.toString=function(){var a=exports.arr.detect(Object.keys(f.categories||{}),function(a){return f.categories[a].indexOf("initialize")>-1})||"default category";return exports.string.format('lively.lang.class.create(%s, "%s",\n"%s", {\n  initialize: %s\n}/*...*/)',f.superclass.type||f.superclass.name,f.type,a,f.prototype.initialize)}}return exports.class.addMethods.apply(Global,[f].concat(b)),f.prototype.initialize||(f.prototype.initialize=function(){}),f},addMethods:function(){for(var a=arguments[0],b=arguments,c=classHelper.defaultCategoryName,d=[],e=1;e<b.length;e++)"string"==typeof b[e]?c=b[e]:Global.RealTrait&&b[e]instanceof RealTrait?d.push(b[e]):exports.class.addCategorizedMethods(a,c,b[e]instanceof Function?b[e]():b[e]);for(e=0;e<d.length;e++)d[e].applyTo(a);return a},addCategorizedMethods:function(a,b,c){a.categories||(a.categories={}),a.categories[b]||(a.categories[b]=[]);var d=a.categories[b];if(!c)throw dbgOn(new Error("no source in addCategorizedMethods!"));var e=a.superclass&&a.superclass.prototype,f=a.type||"Anonymous";for(var g in c)if("constructor"!==g){var h=c.__lookupGetter__(g);h&&a.prototype.__defineGetter__(g,h);var i=c.__lookupSetter__(g);if(i&&a.prototype.__defineSetter__(g,i),!h&&!i){d.push(g);var j=c[g],k=e&&"function"==typeof j&&"$super"==exports.fun.argumentNames(j)[0];if(k&&!function(){var b=j,c=function(a){var b=function(){var b=e[a];if(!b)throw new Error(exports.string.format("Trying to call super of%s>>%s but super method non existing in %s",f,a,e.constructor.type));return b.apply(this,arguments)};return b.varMapping={ancestor:e,m:a},b.isSuperCall=!0,b}(g);c.methodName="$super:"+(a.superclass?a.superclass.type+">>":"")+g,j=exports.obj.extend(exports.fun.wrap(c,b),{valueOf:function(){return b},toString:function(){return b.toString()},originalFunction:b,methodName:c.methodName,isSuperWrapper:!0}),b.varMapping={$super:c}}(),a.prototype[g]=j,"formals"===g)classHelper.addPins(a,j);else if("function"==typeof j)for(j.displayName=f+"$"+g,"undefined"!=typeof lively&&lively.Module&&lively.Module.current&&(j.sourceModule=lively.Module.current());j;j=j.originalFunction)j.declaredClass=a.prototype.constructor.type,j.methodName=g}}return a},addProperties:function(a,b,c){classHelper.addMixin(a,c.prototype.create(b).prototype)},isSubclassOf:function(a,b){return exports.class.superclasses(a).indexOf(b)>-1},superclasses:function(a){return a.superclass?a.superclass===Object?[Object]:exports.class.superclasses(a.superclass).concat([a.superclass]):[]},categoryNameFor:function(a,b){for(var c in a.categories)if(a.categories[c].indexOf(b)>-1)return c;return null},remove:function(a){var b=classHelper.namespaceFor(a.type),c=classHelper.unqualifiedNameFor(a.type);delete b[c]}}}("undefined"!=typeof lively&&lively.lang?lively.lang:require("./base")),function(a){"use strict";var b=a.arr;if(!b)throw new Error("messenger.js needs collection.js!");var c=a.fun;if(!c)throw new Error("messenger.js needs function.js!");var d=a.string;if(!d)throw new Error("messenger.js needs string.js!");var e=a.events;if(!e)throw new Error("messenger.js needs events.js!");var f=a.obj;if(!f)throw new Error("messenger.js needs object.js!");{var g="offline",h="online",i="connecting";a.messenger={OFFLINE:g,ONLINE:h,CONNECTING:i,create:function(a){var c=[{name:"send",args:["msg","callback"]},{name:"listen",args:["messenger","callback"]},{name:"close",args:["messenger","callback"]},{name:"isOnline",args:[]}];c.forEach(function(b){if(!a[b.name]){var c="message implementation needs function "+b.name+"("+b.args.join(",")+")";throw new Error(c)}});var i=a.sendHeartbeat&&(a.heartbeatInterval||1e3),j=a.hasOwnProperty("ignoreUnknownMessages")?a.ignoreUnknownMessages:!1,k={_outgoing:[],_inflight:[],_id:a.id||d.newUUID(),_ignoreUnknownMessages:j,_services:{},_messageCounter:0,_messageResponseCallbacks:{},_whenOnlineCallbacks:[],_statusWatcherProc:null,_startHeartbeatProcessProc:null,_listenInProgress:null,_heartbeatInterval:i,_status:g,_runWhenOnlineCallbacks:function(){var a=b.clone(k._whenOnlineCallbacks);k._whenOnlineCallbacks=[],a.forEach(function(a){try{a.call(null,null,k)}catch(b){console.error("error in _runWhenOnlineCallbacks: %s",b)}})},_ensureStatusWatcher:function(){k._statusWatcherProc||(k._statusWatcherProc=setInterval(function(){k.isOnline()&&k._whenOnlineCallbacks.length&&k._runWhenOnlineCallbacks();var a=k._status;k._status=k.isOnline()?h:g,k._status!==h&&k._statusWatcherProc&&k.reconnect(),k._status!==a&&k.onStatusChange&&k.onStatusChange()},20))},_addMissingData:function(a){if(!a.target)throw new Error("Message needs target!");if(!a.action)throw new Error("Message needs action!");return a.data||(a.data=null),a.messageId||(a.messageId=d.newUUID()),a.sender=k.id(),a.messageIndex=k._messageCounter++,a},_queueSend:function(a,b){if(b&&"function"!=typeof b)throw new Error("Expecing a when send callback, got: "+b);k._outgoing.push([a,b])},_deliverMessageQueue:function(){function c(c){if(-1!==k._inflight.indexOf(c)){var d=c[0],f=c[1];f&&(k._messageResponseCallbacks[d.messageId]=f),a.send.call(k,d,function(a){b.remove(k._inflight,c),a&&e(a,c),k._deliverMessageQueue()})}}function d(c){"number"==typeof a.sendTimeout&&setTimeout(function(){-1!==k._inflight.indexOf(c)&&(b.remove(k._inflight,c),e(new Error("Timeout sending message"),c),k._deliverMessageQueue())},a.sendTimeout)}function e(a,b){var c=b[0],d=b[1];delete k._messageResponseCallbacks[c.messageId],console.error(a),d&&d(a)}if(a.allowConcurrentSends||!k._inflight.length){var f=k._outgoing.shift();f&&(k._inflight.push(f),k.isOnline()?c(f):k.whenOnline(function(){c(f)}),d(f),a.allowConcurrentSends&&k._outgoing.length&&k._deliverMessageQueue())}},_startHeartbeatProcess:function(){k._startHeartbeatProcessProc||(k._startHeartbeatProcessProc=setTimeout(function(){a.sendHeartbeat.call(k,function(){k._startHeartbeatProcessProc=null,k._startHeartbeatProcess()})},k._heartbeatInterval))},id:function(){return k._id},isOnline:function(){return a.isOnline.call(k)},heartbeatEnabled:function(){return"number"==typeof k._heartbeatInterval},listen:function(b){return k._listenInProgress?void 0:(k._listenInProgress=!0,k._ensureStatusWatcher(),a.listen.call(k,function(a){k._listenInProgress=null,b&&b(a),k.heartbeatEnabled()&&k._startHeartbeatProcess()}))},reconnect:function(){return k._status!==h?(k.listen(),k):void 0},send:function(a,b){return k._addMissingData(a),k._queueSend(a,b),k._deliverMessageQueue(),a},sendTo:function(a,b,c,d){var e={target:a,action:b,data:c};return k.send(e,d)},onMessage:function(a){if(k.emit("message",a),a.inResponseTo){var b=k._messageResponseCallbacks[a.inResponseTo];b&&!a.expectMoreResponses&&delete k._messageResponseCallbacks[a.inResponseTo],b&&b(null,a)}else{var c=k._services[a.action];if(c)try{c.call(null,a,k)}catch(d){console.error("Error invoking service: "+d),k.answer(a,{error:String(d)})}else if(!k._ignoreUnknownMessages){var e=new Error("messageNotUnderstood: "+a.action);k.answer(a,{error:String(e)})}}},answer:function(a,b,c,d){"function"==typeof c&&(d=c,c=!1);var e={target:a.sender,action:a.action+"Result",inResponseTo:a.messageId,data:b};return c&&(e.expectMoreResponses=!0),k.send(e,d)},close:function(b){return clearInterval(k._statusWatcherProc),k._statusWatcherProc=null,a.close.call(k,function(a){k._status=g,b&&b(a)}),k},whenOnline:function(a){return k._whenOnlineCallbacks.push(a),k.isOnline()&&k._runWhenOnlineCallbacks(),k},outgoingMessages:function(){return b.pluck(k._inflight.concat(k._outgoing),0)},addServices:function(a){return f.extend(k._services,a),k}};return a.services&&k.addServices(a.services),e.makeEmitter(k),k}}}}("undefined"!=typeof lively&&lively.lang?lively.lang:require("./base")),function(exports){"use strict";var isNodejs="undefined"!=typeof module&&module.require,WorkerSetup={loadDependenciesBrowser:function(a){importScripts.apply(this,a.scriptsToLoad||[])},loadDependenciesNodejs:function(a){var b=global.lively||(global.lively={});b.lang=require(require("path").join(a.libLocation,"index"))},initBrowserGlobals:function(){remoteWorker.send=function(a){postMessage(a)},Global=this,Global.window=Global,Global.console=Global.console||function(){var a={};return["log","error","warn"].forEach(function(b){a[b]=function(){for(var a=arguments[0],c=1;c<arguments.length;c++)a=a.replace("%s",arguments[c]);remoteWorker.send({type:b,message:["[",b.toUpperCase(),"] ",a].join("")})}}),a}()},initOnMessageHandler:function(){function a(a){if(a=a.data.data?a.data:a,remoteWorker.messenger)remoteWorker.messenger.onMessage(a);else if("close"==a.action)return remoteWorker.send({type:"closed",workerReady:!1}),void remoteWorker.close()}remoteWorker.on?remoteWorker.on("message",a):remoteWorker.onmessage=a},initWorkerInterface:function initWorkerInterface(options){remoteWorker.callStringifiedFunction=function(stringifiedFunc,args,thenDo){var func;try{func=eval("("+stringifiedFunc+")")}catch(e){return void thenDo(new Error("Cannot create function from string: "+e.stack||e))}var usesCallback=func.length===args.length+1,whenDone=lively.lang.fun.once(function(a,b){remoteWorker.isBusy=!1,thenDo(a,b)});remoteWorker.isBusy=!0,usesCallback&&args.push(whenDone);try{var result=func.apply(remoteWorker,args.concat([whenDone]))}catch(e){return void whenDone(e,null)}usesCallback||whenDone(null,result)},remoteWorker.httpRequest=function(a){function b(){4===c.readyState&&a.done&&a.done(c)}if(!a.url)return void console.log("Error, httpRequest needs url");var c=new XMLHttpRequest,d=a.method||"GET";c.onreadystatechange=b,c.open(d,a.url),c.send()},remoteWorker.terminateIfNotBusyIn=function(a){setTimeout(function(){return remoteWorker.isBusy?void remoteWorker.terminateIfNotBusyIn(a):(remoteWorker.send({type:"closed",workerReady:!1}),void remoteWorker.close())},a)}},initWorkerMessenger:function initWorkerMessenger(options){if(!options.useMessenger)return null;if(!lively.lang.messenger)throw new Error("worker.create requires messenger.js to be loaded!");if(!lively.lang.events)throw new Error("worker.create requires events.js to be loaded!");return remoteWorker.messenger=lively.lang.messenger.create({services:{remoteEval:function(msg,messenger){var result;try{result=eval(msg.data.expr)}catch(e){result=e.stack||e}messenger.answer(msg,{result:String(result)})},run:function(a,b){var c=a.data.func,d=a.data.args;return c?void remoteWorker.callStringifiedFunction(c,d,function(c,d){b.answer(a,{error:c?String(c):null,result:d})}):void b.answer(a,{error:"no funcString"})},close:function(a,b){b.answer(a,{status:"OK"}),remoteWorker.send({type:"closed",workerReady:!1}),remoteWorker.close()}},isOnline:function(){return!0},send:function(a,b){remoteWorker.send(a),b()},listen:function(a){a()},close:function(){remoteWorker.send({type:"closed",workerReady:!1}),remoteWorker.close()}})}},BrowserWorker={create:function(a){function b(a,b){exports.events.makeEmitter(b),a.scriptsToLoad||(a.scriptsToLoad=["base.js","events.js","object.js","collection.js","function.js","string.js","number.js","date.js","messenger.js","worker.js"].map(function(b){return a.libLocation+b}));var c=Object.keys(a).reduce(function(b,c){return"function"!=typeof a[c]&&(b[c]=a[c]),b},{});b.onmessage=function(a){void 0!==a.data.workerReady?(b.ready=!!a.data.workerReady,b.emit(b.ready?"ready":"close")):b.emit("message",a.data)},b.errors=[],b.onerror=function(a){console.error(a),b.errors.push(a),b.emit("error",a)},b.postMessage({action:"setup",options:c})}function c(){var a=self;a.onmessage=function(a){if("setup"!==a.data.action)throw new Error("expected setup to be first message but got "+JSON.stringify(a.data));var b=a.data.options||{};initBrowserGlobals(b),loadDependenciesBrowser(b),initOnMessageHandler(b),initWorkerInterface(b),initWorkerMessenger(b),postMessage({workerReady:!0})}}function d(a){var b;try{b=new Blob([a],{type:"text/javascript"})}catch(c){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder,b=new BlobBuilder,b.append(a),b=b.getBlob()}var d="undefined"!=typeof webkitURL?webkitURL:URL;return d.createObjectURL(b)}if(a=a||{},!a.libLocation&&!a.scriptsToLoad){var e=document.querySelector('script[src$="worker.js"]');if(!e)throw new Error('Cannot find library path to start worker. Use worker.create({libLocation: "..."}) to explicitly define the path!');a.libLocation=e.src.replace(/worker.js$/,"")}var f=String(c).replace("__FUNCTIONDECLARATIONS__",[WorkerSetup.initBrowserGlobals,WorkerSetup.loadDependenciesBrowser,WorkerSetup.initOnMessageHandler,WorkerSetup.initWorkerInterface,WorkerSetup.initWorkerMessenger].join("\n")),g="("+f+")();",h=new Worker(d(g));return b(a,h),h}},NodejsWorker={debug:!1,initCodeFileCreated:!1,create:function(a){a=a||{};var b,c=exports.events.makeEmitter({ready:!1,errors:[],postMessage:function(a){return b?c.ready?void b.send(a):void c.emit("error",new Error("nodejs worker process not ready or already closed")):void c.emit("error",new Error("nodejs worker process not yet created"))}});return NodejsWorker.startWorker(a,function(a,d){return a?(c.ready=!1,void c.emit("error",a)):(b=d,b.on("message",function(a){NodejsWorker.debug&&console.log("[WORKER PARENT] got message:",a),c.emit("message",a)}),b.on("close",function(){console.log("[WORKER PARENT] worker closed"),c.emit("close")}),b.on("error",function(a){console.log("[WORKER PARENT] error ",a),c.errors.push(a),c.emit("error",a)}),c.ready=!0,void c.emit("ready"))}),c},workerSetupFunction:function(){var a=process,b=!0;b&&console.log("[WORKER] Starting init"),a.on("message",function(c){if("setup"!==c.action)throw new Error("expected setup to be first message but got "+JSON.stringify(c.data));a.removeAllListeners("message");var d=c.data.options||{};b&&console.log("[WORKER] running setup with options",d),loadDependenciesNodejs(d),initOnMessageHandler(d),initWorkerInterface(d),initWorkerMessenger(d),a.send({workerReady:!0})})},ensureInitCodeFile:function(a,b,c){var d=require("path"),e=require("os"),f=require("fs"),g=d.join(e.tmpDir(),"lively-nodejs-workers/"),h=d.join(g,"nodejs-worker-init.js");NodejsWorker.initCodeFileCreated?f.exists(h,function(d){d?c(null,h):NodejsWorker.createWorkerCodeFile(a,h,b,c)}):NodejsWorker.createWorkerCodeFile(a,h,b,c)},createWorkerCodeFile:function(a,b,c,d){var e=require("path"),f=require("fs"),g=require("child_process").exec;g("mkdir -p "+e.dirname(b),function(a,e,g){return a?void d(new Error(["[WORKER PARENT] Could not create worker temp dir:",e,g].join("\n"))):void f.writeFile(b,c,function(a){NodejsWorker.debug&&console.log("worker code file %s created",b),NodejsWorker.initCodeFileCreated=!0,d(a,b)})})},startWorker:function(a,b){var c=require("util"),d=require("child_process").fork,e=String(NodejsWorker.workerSetupFunction).replace("__FUNCTIONDECLARATIONS__",[WorkerSetup.loadDependenciesNodejs,WorkerSetup.initOnMessageHandler,WorkerSetup.initWorkerInterface,WorkerSetup.initWorkerMessenger].join("\n")),f=c.format("(%s)();\n",e);NodejsWorker.ensureInitCodeFile(a,f,function(c,e){if(c)return b(c);var f=d(e,{});NodejsWorker.debug&&console.log("worker forked"),f.on("message",function(a){"pong"===a.action?console.log("[WORKER pong] ",a):"log"===a.action&&console.log("[Message from WORKER] ",a.data)}),f.once("message",function(a){NodejsWorker.debug&&console.log("worker setup done"),b(null,f,a)}),f.on("close",function(){NodejsWorker.debug&&console.log("[WORKER PARENT] worker closed")}),f.send({action:"setup",data:{options:a}}),global.WORKER=f})}},worker=exports.worker={fork:function(a,b,c){c||(c=b,b=a,a=null),a=a||{};var d=a.args||[],e=worker.create(a);return e.run.apply(e,[b].concat(d).concat(c)),e},create:function(a){if(a=a||{},a.useMessenger=!0,!exports.messenger)throw new Error("worker.create requires messenger.js to be loaded!");if(!exports.events)throw new Error("worker.create requires events.js to be loaded!");if(!exports.obj)throw new Error("worker.create requires object.js to be loaded!");var b=a.workerId||exports.string.newUUID(),c=exports.messenger.create({sendTimeout:5e3,send:function(a,b){c.worker.postMessage(a),b()},listen:function(b){var d=c.worker=isNodejs?NodejsWorker.create(a):BrowserWorker.create(a);d.on("message",function(a){c.onMessage(a)}),d.on("ready",function(){NodejsWorker.debug&&console.log("WORKER READY!!!")
}),d.on("close",function(){NodejsWorker.debug&&console.log("WORKER CLOSED...!!!")}),d.once("ready",b)},close:function(a){return c.worker.ready?c.sendTo(b,"close",{},function(b,d){if(b=b||d.data.error,b&&console.error("Error in worker messenger close: "+b.stack||b),b)a(b);else{var e=!1;c.worker.once("close",function(){e=!0}),exports.fun.waitFor(1e3,function(){return!!e},a)}}):a(null)},isOnline:function(){return c.worker&&c.worker.ready}});return exports.obj.extend(c,{eval:function(a,d){c.sendTo(b,"remoteEval",{expr:a},function(a,b){d(a,b?b.data.result:null)})},run:function(){var a=Array.prototype.slice.call(arguments),d=a.shift(),e=a.pop();if("function"!=typeof d)throw new Error("run: no function that should run in worker passed");if("function"!=typeof e)throw new Error("run: no callback passed");return c.sendTo(b,"run",{func:String(d),args:a},function(a,b){e(a||b.data.error,b?b.data.result:null)})}}),c.listen(),c}}}("undefined"!=typeof lively&&lively.lang?lively.lang:require("./base"));
//# sourceMappingURL=lively.lang.min.js.map